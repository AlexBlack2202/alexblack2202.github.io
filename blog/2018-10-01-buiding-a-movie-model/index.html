<!doctype html><html lang="en" data-palette="blue"
   data-mode="dark">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Xây dựng chương trình gợi ý phim dựa vào tập dữ liệu movie len - Phạm Duy Tùng Machine Learning Blog</title><link rel="apple-touch-icon" href="/images/icons/icon-180x180.png" sizes="180x180">
<link rel="icon" href="/images/icons/icon-32x32.png" sizes="32x32" type="image/png">
<link rel="icon" href="/images/icons/icon-16x16.png" sizes="16x16" type="image/png">
<link rel="icon" href="/images/icons/favicon.ico">
<link rel="manifest" href="/manifest.json">
<meta name="keywords" content="" />
<meta name="description" content="Ở bài viết này, tôi sẽ tập trung vào vào sử dụng implement Alternating Least Saqures của Collaborative Filtering trong thư viện Spark MLlib trên tập dữ liệu movieLens." /><meta name="robots" content="index, follow" /><meta itemprop="name" content="Xây dựng chương trình gợi ý phim dựa vào tập dữ liệu movie len">
<meta itemprop="description" content="Ở bài viết này, tôi sẽ tập trung vào vào sử dụng implement Alternating Least Saqures của Collaborative Filtering trong thư viện Spark MLlib trên tập dữ liệu movieLens."><meta itemprop="datePublished" content="2018-10-01T00:19:00+03:00" />
<meta itemprop="dateModified" content="2018-10-01T00:19:00+03:00" />
<meta itemprop="wordCount" content="1892">
<meta itemprop="keywords" content="Machine learning,Deeplearning,Spark," /><meta property="og:title" content="Xây dựng chương trình gợi ý phim dựa vào tập dữ liệu movie len" />
<meta property="og:description" content="Ở bài viết này, tôi sẽ tập trung vào vào sử dụng implement Alternating Least Saqures của Collaborative Filtering trong thư viện Spark MLlib trên tập dữ liệu movieLens." />
<meta property="og:type" content="article" />
<meta property="og:url" content="/blog/2018-10-01-buiding-a-movie-model/" /><meta property="article:section" content="blog" />
<meta property="article:published_time" content="2018-10-01T00:19:00+03:00" />
<meta property="article:modified_time" content="2018-10-01T00:19:00+03:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Xây dựng chương trình gợi ý phim dựa vào tập dữ liệu movie len"/>
<meta name="twitter:description" content="Ở bài viết này, tôi sẽ tập trung vào vào sử dụng implement Alternating Least Saqures của Collaborative Filtering trong thư viện Spark MLlib trên tập dữ liệu movieLens."/>
<meta property="og:image" content="/images/logo.png"/>
  <meta name="twitter:image" content="/images/logo.png"/><link rel="stylesheet" href="/css/main.min.507afbe6e4670fa3e961a0b35816b5daeb36029866fd6bd7b9d7871fcf88faa5.css" integrity="sha256-UHr75uRnD6PpYaCzWBa12us2Aphm/WvXudeHH8&#43;I&#43;qU=" crossorigin="anonymous"><link rel="stylesheet" href="/css/katex.min.d080a89e03e1eb850f547d835c186b4273f69879aa497eb8b0e88c1578bf1f0b.css" integrity="sha256-0ICongPh64UPVH2DXBhrQnP2mHmqSX64sOiMFXi/Hws=" crossorigin="anonymous">
<link rel="stylesheet" href="/css/viewer.min.3d228794bcedbbfa0412beb8fbc1ec6973202945e42af7004f742a4d7bd620ab.css" integrity="sha256-PSKHlLztu/oEEr64&#43;8HsaXMgKUXkKvcAT3QqTXvWIKs=" crossorigin="anonymous"></head>
  <body><script>const items=['mode','palette'];items.forEach(function(a){const b=localStorage.getItem('hbs-'+a);b&&document.body.parentElement.setAttribute('data-'+a,b)})</script><header><nav class="navbar top-app-bar top-app-bar-expand-lg fixed-top">
  <div class="container">
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent"
      aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <i class="fas fa-bars"></i>
    </button><a class="navbar-brand flex-grow-1 flex-lg-grow-0 text-center text-lg-start mx-auto me-lg-3" href="/"><img class="logo" alt="Logo" src="/images/logo.webp" loading="lazy"
   width="400" height="400"
   />
HOME
    </a>
    <div class="offcanvas offcanvas-bottom surface" tabindex="-1" id="offcanvasSocialShare" aria-labelledby="offcanvasSocialShare">
  <div class="offcanvas-header">
    <h3 class="offcanvas-title">Share</h3>
    <button type="button" class="btn btn-sm btn-outline-primary" data-bs-dismiss="offcanvas" aria-label="Close">
      <i class="fas fa-times"></i>
    </button>
  </div>
  <div class="offcanvas-body">
    <a class="btn btn-sm btn-outline-primary social-share-button" rel="noopener noreferrer" aria-label="Twitter Share Button"
      target="_blank" href="https://twitter.com/intent/tweet?title=X%c3%a2y%20d%e1%bb%b1ng%20ch%c6%b0%c6%a1ng%20tr%c3%acnh%20g%e1%bb%a3i%20%c3%bd%20phim%20d%e1%bb%b1a%20v%c3%a0o%20t%e1%ba%adp%20d%e1%bb%af%20li%e1%bb%87u%20movie%20len&url=%2fblog%2f2018-10-01-buiding-a-movie-model%2f">
      <i class="fab fa-fw fa-twitter"></i> Twitter
    </a>
    <a class="btn btn-sm btn-outline-primary social-share-button" rel="noopener noreferrer" aria-label="Facebook Share Button"
      target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=%2fblog%2f2018-10-01-buiding-a-movie-model%2f">
      <i class="fab fa-fw fa-facebook-f"></i> Facebook
    </a>
  </div>
</div>
    <button class="navbar-settings" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasSettings"
  aria-controls="offcanvasSettings" aria-label="Toggle settings">
  <i class="fas fa-ellipsis-v"></i>
</button>

<div class="offcanvas offcanvas-end surface h-100" tabindex="-1" id="offcanvasSettings" aria-labelledby="offcanvasSettings">
  <div class="offcanvas-header">
    <h3 class="offcanvas-title">Settings</h3>
    <button type="button" class="btn btn-sm btn-outline-primary" data-bs-dismiss="offcanvas" aria-label="Close">
      <i class="fas fa-times"></i>
    </button>
  </div>
  <div class="offcanvas-body d-flex flex-column">



<section class="setting">
  <form class="font-size-switcher-form row">
    <div class="col-auto">
      <label for="fontSize" class="form-label"><i class="fas fa-fw fa-font"></i> Font Size</label>
    </div>
    <div class="col-auto ms-auto">
      <input type="range" class="form-range" min="-2" max="2" id="fontSize">
    </div>
  </form>
</section>


<section class="setting palettes">
  <form class="row">
    <div class="col-auto">
      <label><i class="fas fa-fw fa-palette"></i> Palette</label>
    </div>
    <div class="col-auto ms-auto">
      <a id="btnPalette" class="btn btn-sm btn-outline-primary" role="button" aria-label="palettePicker">
        <i class="fas fa-eye-dropper"></i>
      </a>
    </div>
  </form>
  <div class="mt-2 d-flex justify-content-between visually-hidden" id="palettePicker"><button type="button" id="palette-blue" aria-label="Blue"
        class="btn btn-sm w-100 palette" data-palette="blue">
      </button><button type="button" id="palette-blue-gray" aria-label="Blue Gray"
        class="btn btn-sm w-100 palette" data-palette="blue-gray">
      </button><button type="button" id="palette-brown" aria-label="Brown"
        class="btn btn-sm w-100 palette" data-palette="brown">
      </button><button type="button" id="palette-cyan" aria-label="Cyan"
        class="btn btn-sm w-100 palette" data-palette="cyan">
      </button><button type="button" id="palette-green" aria-label="Green"
        class="btn btn-sm w-100 palette" data-palette="green">
      </button><button type="button" id="palette-indigo" aria-label="Indigo"
        class="btn btn-sm w-100 palette" data-palette="indigo">
      </button><button type="button" id="palette-orange" aria-label="Orange"
        class="btn btn-sm w-100 palette" data-palette="orange">
      </button><button type="button" id="palette-pink" aria-label="Pink"
        class="btn btn-sm w-100 palette" data-palette="pink">
      </button><button type="button" id="palette-purple" aria-label="Purple"
        class="btn btn-sm w-100 palette" data-palette="purple">
      </button><button type="button" id="palette-red" aria-label="Red"
        class="btn btn-sm w-100 palette" data-palette="red">
      </button><button type="button" id="palette-teal" aria-label="Teal"
        class="btn btn-sm w-100 palette" data-palette="teal">
      </button><button type="button" id="palette-yellow" aria-label="Yellow"
        class="btn btn-sm w-100 palette" data-palette="yellow">
      </button></div>
</section>
<section class="setting actions d-flex justify-content-around mt-auto overflow-auto">
  <a role="button" class="action action-go-back" href="javascript: window.history.back();">
    <span class="action-icon"><i class="fas fa-2x fa-arrow-left"></i></span> Go back
  </a>
  <a role="button" class="action action-reload-page">
    <span class="action-icon"><i class="fas fa-2x fa-redo-alt"></i></span> Reload
  </a>
  <a role="button" class="action action-copy-url">
    <span class="action-icon"><i class="fas fa-2x fa-link"></i></span> Copy URL
  </a><a class="action action-social-share" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasSocialShare"
    aria-controls="offcanvasSocialShare" aria-label="Toggle social share">
    <span class="action-icon"><i class="fas fa-2x fa-share-alt"></i></span> Share
  </a></section>

</div>
</div>

    <div class="collapse navbar-collapse" tabindex="-1" id="navbarSupportedContent" aria-labelledby="navbarSupportedContent">
      <form class="search-bar my-1" action="/search">
  <div class="input-group input-group-sm">
    <span class="btn btn-search disabled position-absolute left-0"><i class="fas fa-fw fa-search"></i></span>
    <input class="form-control rounded-pill" name="q" type="search" aria-label="Search">
  </div>
</form>
      <ul class="navbar-nav ms-auto"><li class="nav-item">
          <a class="nav-link" href="/series/">
            <i class="fas fa-fw fa-columns"></i>Series
          </a>
        </li><li class="nav-item">
          <a class="nav-link" href="/archives/">
            <i class="fas fa-fw fa-file-archive"></i>Archives
          </a>
        </li><li class="nav-item">
          <a class="nav-link" href="/categories/">
            <i class="fas fa-fw fa-folder"></i>Categories
          </a>
        </li><li class="nav-item">
          <a class="nav-link" href="/tools/">
            <i class="fas fa-fw fa-folder"></i>Tools
          </a>
        </li><li class="nav-item">
          <a class="nav-link" href="/tags/">
            <i class="fas fa-fw fa-tags"></i>Tags
          </a>
        </li><li class="nav-item dropdown">
          <a class="nav-link" id="navbarDropdownSupport" role="button" data-bs-toggle="dropdown" aria-expanded="false">
            <i class="fas fa-fw fa-chevron-circle-down"></i>Support
          </a>
          <ul class="dropdown-menu" aria-labelledby="navbarDropdownSupport"><li>
              <a class="dropdown-item"
                href="https://www.facebook.com/groups/1354425091720104" target="_blank" rel="noopener noreferrer">
                Repository
              </a>
            </li><li>
              <a class="dropdown-item"
                href="https://www.facebook.com/groups/1354425091720104" target="_blank" rel="noopener noreferrer">
                Discussions
              </a>
            </li><li>
              <a class="dropdown-item"
                href="https://www.facebook.com/groups/1354425091720104" target="_blank" rel="noopener noreferrer">
                Features Request
              </a>
            </li><li><hr class="dropdown-divider"></li><li>
              <a class="dropdown-item"
                href="/faq/">
                FAQs
              </a>
            </li></ul>
        </li></ul>
    </div>
  </div>
</nav>
</header>
<main role="main" class="container">
      <div class="row content">
<div class="col-lg-8">
  <div class="container"><nav class="row card component" aria-label="breadcrumb">
  <div class="card-body">
    <ol class="breadcrumb "><li class="breadcrumb-item"><a href="/">Home</a></li><li class="breadcrumb-item"><a href="/blog/">Blogs</a></li><li class="breadcrumb-item active">Xây Dựng Chương Trình Gợi Ý Phim Dựa Vào Tập Dữ Liệu Movie Len</li></ol>
  </div>
</nav>
<div class="post-panel-wrapper">
  <div class="d-flex flex-column component rounded post-panel">
    
    <a class="action action-panel-toggler" role="button" title="Panel toggler">
      <i class="fas fa-fw fa-chevron-circle-down"></i>
    </a>
    <a id="sidebarToggler" class="action d-none d-lg-block" role="button" title="Sidebar toggler">
  <i class="fas fa-fw fa-expand-alt" data-fa-transform="rotate-45"></i>
</a>

    

    
    
    <a class="action" href="#post-comments" role="button" aria-label="Comments" title="Comments">
  <i class="fas fa-fw fa-comments"></i>
</a>
    <a class="action" href="#postTOC" aria-controls="Table of contents" role="button" title="Table of contents">
  <i class="fas fa-fw fa-list-alt"></i>
</a>
    
  </div>
</div>
<article class="row card component mb-4 post">
  <div class="card-header ">
    <h1 class="card-title post-title">Xây Dựng Chương Trình Gợi Ý Phim Dựa Vào Tập Dữ Liệu Movie Len
</h1>
  </div>
  <div class="card-body"><div class="post-meta">
  <span class="post-date" title="created on 2018-10-01 04:19:00 &#43;0700 &#43;07.">
    Oct 1, 2018
  </span><span class="post-reading-time">
    9 min read
  </span><span class="post-taxonomies"><a href="/tags/machine-learning/" class="badge post-taxonomy">Machine learning</a><a href="/tags/deeplearning/" class="badge post-taxonomy">Deeplearning</a><a href="/tags/spark/" class="badge post-taxonomy">Spark</a></span>
</div>
<div class="post-content mb-3"><h2 id="lời-mở-đầu">Lời mở đầu<a class="anchor ms-1" href="#lời-mở-đầu"><i class="fas fa-link"></i></a></h2>
<p>MovieLens là một tập dữ liệu được sử dụng rộng rãi cách đây nhiều năm. Hôm nay, mình sẽ sử dụng tập dữ liệu này và mô hình ALS của spark để xây dựng chương trình dự đoán phim cho người dùng.</p>
<h2 id="chuẩn-bị-dữ-liệu">Chuẩn bị dữ liệu<a class="anchor ms-1" href="#chuẩn-bị-dữ-liệu"><i class="fas fa-link"></i></a></h2>
<p>Các bạn có thể download tập dữ liệu MovieLens ở link <a href="https://grouplens.org/datasets/movielens/" target="_blank" rel="noopener noreferrer">https://grouplens.org/datasets/movielens/</a>. Các bạn có thể download trực tiếp 2 file nén ở link <a href="http://files.grouplens.org/datasets/movielens/ml-latest-small.zip" target="_blank" rel="noopener noreferrer">http://files.grouplens.org/datasets/movielens/ml-latest-small.zip</a> và link  <a href="http://files.grouplens.org/datasets/movielens/ml-latest.zip" target="_blank" rel="noopener noreferrer">http://files.grouplens.org/datasets/movielens/ml-latest.zip</a>.</p>
<p>Ở trên bao gồm 2 tập dữ liệu. chúng ta tạo thư mục datasets và download rồi bỏ chúng vào trong thư mục đấy.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="ln"> 1</span><span class="n">complete_dataset_url</span> <span class="o">=</span> <span class="s1">&#39;http://files.grouplens.org/datasets/movielens/ml-latest.zip&#39;</span>
<span class="ln"> 2</span><span class="n">small_dataset_url</span> <span class="o">=</span> <span class="s1">&#39;http://files.grouplens.org/datasets/movielens/ml-latest-small.zip&#39;</span>
<span class="ln"> 3</span>
<span class="ln"> 4</span><span class="kn">import</span> <span class="nn">os</span>
<span class="ln"> 5</span>
<span class="ln"> 6</span><span class="n">datasets_path</span> <span class="o">=</span> <span class="s1">&#39;datasets&#39;</span>
<span class="ln"> 7</span><span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">datasets_path</span><span class="p">):</span>
<span class="ln"> 8</span>    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">datasets_path</span><span class="p">))</span>
<span class="ln"> 9</span>
<span class="ln">10</span><span class="n">complete_dataset_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">datasets_path</span><span class="p">,</span> <span class="s1">&#39;ml-latest.zip&#39;</span><span class="p">)</span>
<span class="ln">11</span><span class="n">small_dataset_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">datasets_path</span><span class="p">,</span> <span class="s1">&#39;ml-latest-small.zip&#39;</span><span class="p">)</span>
<span class="ln">12</span>
<span class="ln">13</span><span class="kn">import</span> <span class="nn">urllib</span>
<span class="ln">14</span><span class="kn">import</span> <span class="nn">zipfile</span>
<span class="ln">15</span>
<span class="ln">16</span><span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">small_dataset_url</span><span class="p">):</span>
<span class="ln">17</span>	<span class="n">small_f</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">urlretrieve</span> <span class="p">(</span><span class="n">small_dataset_url</span><span class="p">,</span> <span class="n">small_dataset_path</span><span class="p">)</span><span class="c1">#Download</span>
<span class="ln">18</span>	<span class="k">with</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">small_dataset_path</span><span class="p">,</span> <span class="s2">&#34;r&#34;</span><span class="p">)</span> <span class="k">as</span> <span class="n">z</span><span class="p">:</span><span class="c1">#Giải nén</span>
<span class="ln">19</span>		<span class="n">z</span><span class="o">.</span><span class="n">extractall</span><span class="p">(</span><span class="n">datasets_path</span><span class="p">)</span>
<span class="ln">20</span><span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">small_dataset_url</span><span class="p">):</span>
<span class="ln">21</span>	<span class="n">complete_f</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">urlretrieve</span> <span class="p">(</span><span class="n">complete_dataset_url</span><span class="p">,</span> <span class="n">complete_dataset_path</span><span class="p">)</span><span class="c1">#Download</span>
<span class="ln">22</span>	<span class="k">with</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">complete_dataset_path</span><span class="p">,</span> <span class="s2">&#34;r&#34;</span><span class="p">)</span> <span class="k">as</span> <span class="n">z</span><span class="p">:</span><span class="c1">#Giải nén</span>
<span class="ln">23</span>		<span class="n">z</span><span class="o">.</span><span class="n">extractall</span><span class="p">(</span><span class="n">datasets_path</span><span class="p">)</span>
<span class="ln">24</span>
</code></pre></div><p>Trong thư mục giải nén, chúng ta sẽ có các file ratings.csv, movies.csv, tags.csv, links.csv, README.txt.</p>
<h2 id="loading-và-parsing-dữ-liệu">Loading và parsing dữ liệu.<a class="anchor ms-1" href="#loading-và-parsing-dữ-liệu"><i class="fas fa-link"></i></a></h2>
<p>Mỗi dòng trong tập ratings.csv có định dạng <code>&quot;userId,movieId,rating,timestamp&quot;</code>.</p>
<p>Mỗi dòng trong tập movies.csv có định dạng <code>&quot;movieId,title,genres&quot;</code>.</p>
<p>Mỗi dòng trong tập tags.csv có định dạng <code>&quot;userId,movieId,tag,timestamp&quot;</code>.</p>
<p>Mỗi dòng trong tập links.csv có định dạng <code>&quot;movieId,imdbId,tmdbId&quot;</code>.</p>
<p>Tóm lại, các trường dữ liệu trong các file csv đều ngăn cách nhau bởi dấu phẩy (,). Trong python, ta có thể dùng hàm split để cắt chúng ra. Sau đó sẽ load toàn bộ dữ liệu lên RDDs.</p>
<p>Lưu ý nhỏ:</p>
<ul>
<li>Ở tập dữ liệu ratings, chúng ta chỉ giữ lại các trường <code>(UserID, MovieID, Rating)</code> bỏ đi trường timestamp vì không cần thiết.</li>
<li>Ở tập dữ liệu movies  chúng ta giữ lại trường <code>(MovieID, Title)</code> và bỏ đi trường genres vì lý do tương tự.</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="ln"> 1</span><span class="n">small_ratings_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">datasets_path</span><span class="p">,</span> <span class="s1">&#39;ml-latest-small&#39;</span><span class="p">,</span> <span class="s1">&#39;ratings.csv&#39;</span><span class="p">)</span>
<span class="ln"> 2</span><span class="n">small_ratings_raw_data</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">textFile</span><span class="p">(</span><span class="n">small_ratings_file</span><span class="p">)</span>
<span class="ln"> 3</span><span class="n">small_ratings_raw_data_header</span> <span class="o">=</span> <span class="n">small_ratings_raw_data</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="ln"> 4</span><span class="n">small_ratings_data</span> <span class="o">=</span> <span class="n">small_ratings_raw_data</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">line</span><span class="p">:</span> <span class="n">line</span><span class="o">!=</span><span class="n">small_ratings_raw_data_header</span><span class="p">)</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">line</span><span class="p">:</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&#34;,&#34;</span><span class="p">))</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">tokens</span><span class="p">:</span> <span class="p">(</span><span class="n">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">tokens</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">tokens</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span><span class="o">.</span><span class="n">cache</span><span class="p">()</span>
<span class="ln"> 5</span><span class="nb">print</span><span class="p">(</span><span class="n">small_ratings_data</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span> <span class="c1">#Hiện thị top 3 ratting đầu tiên</span>
<span class="ln"> 6</span>
<span class="ln"> 7</span><span class="n">small_movies_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">datasets_path</span><span class="p">,</span> <span class="s1">&#39;ml-latest-small&#39;</span><span class="p">,</span> <span class="s1">&#39;movies.csv&#39;</span><span class="p">)</span>
<span class="ln"> 8</span>
<span class="ln"> 9</span><span class="n">small_movies_raw_data</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">textFile</span><span class="p">(</span><span class="n">small_movies_file</span><span class="p">)</span>
<span class="ln">10</span><span class="n">small_movies_raw_data_header</span> <span class="o">=</span> <span class="n">small_movies_raw_data</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="ln">11</span>
<span class="ln">12</span><span class="n">small_movies_data</span> <span class="o">=</span> <span class="n">small_movies_raw_data</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">line</span><span class="p">:</span> <span class="n">line</span><span class="o">!=</span><span class="n">small_movies_raw_data_header</span><span class="p">)</span>\
<span class="ln">13</span>    <span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">line</span><span class="p">:</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&#34;,&#34;</span><span class="p">))</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">tokens</span><span class="p">:</span> <span class="p">(</span><span class="n">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">tokens</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span><span class="o">.</span><span class="n">cache</span><span class="p">()</span>
<span class="ln">14</span>    
<span class="ln">15</span><span class="n">small_movies_data</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="c1">#Hiện thị top 3 movie đầu tiên</span>
</code></pre></div><p>Phần tiếp theo, chúng ta sẽ tìm hiểu lọc cộng tác (Collaborative Filtering) và cách sử dụng Spark MLlib để xây dựng mô hình dự báo.</p>
<h2 id="collaborative-filtering">Collaborative Filtering<a class="anchor ms-1" href="#collaborative-filtering"><i class="fas fa-link"></i></a></h2>
<p>Ở đây, tôi sẽ không đề cập đến lọc cộng tác là gì, các bạn có nhu cầu tìm hiểu có thể xem ở bài post khác hoặc tham khảo trên wiki. Chúng ta sẽ tập trung vào tìm hiểu cách sử dụng ALS trong thư viện MLlib của Spark. Các tham số của thuật toán này bao gồm:</p>
<ul>
<li>
<p>numBlocks: số lượng block được sử dụng trong tính toán song song (-1 với ý nghĩa là auto configure).</p>
</li>
<li>
<p>rank: số lượng nhân tố ẩn (latent factor) trong mô hình.</p>
</li>
<li>
<p>iterations: số lần lặp.</p>
</li>
<li>
<p>lambda: tham số của chuẩn hoá(regularization ) trong ALS.</p>
</li>
<li>
<p>implicitPrefs specifies whether to use the explicit feedback ALS variant or one adapted for implicit feedback data.</p>
</li>
<li>
<p>alpha is a parameter applicable to the implicit feedback variant of ALS that governs the baseline confidence in preference observations.</p>
</li>
</ul>
<h2 id="chọn-các-tham-số-cho-als">Chọn các tham số cho ALS<a class="anchor ms-1" href="#chọn-các-tham-số-cho-als"><i class="fas fa-link"></i></a></h2>
<p>Để chọn được các tham số tốt nhất cho mô hình ALS, chúng ta sẽ sử dụng tập small để grid search. Đầu tiên, chúng ta chia tập dữ liệu thành 3 phần là tập train, tập vali và  tập test. Sau đó tiến hành huấn luyện trên tập train và predict trên tập valid để tìm được tham số tốt nhất. Cuối cùng đánh giá kết quả đạt được trên tập test.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="ln"> 1</span><span class="n">training_RDD</span><span class="p">,</span> <span class="n">validation_RDD</span><span class="p">,</span> <span class="n">test_RDD</span> <span class="o">=</span> <span class="n">small_ratings_data</span><span class="o">.</span><span class="n">randomSplit</span><span class="p">([</span><span class="mi">6</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">seed</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="ln"> 2</span><span class="n">validation_for_predict_RDD</span> <span class="o">=</span> <span class="n">validation_RDD</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
<span class="ln"> 3</span><span class="n">test_for_predict_RDD</span> <span class="o">=</span> <span class="n">test_RDD</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
<span class="ln"> 4</span>
<span class="ln"> 5</span><span class="kn">from</span> <span class="nn">pyspark.mllib.recommendation</span> <span class="kn">import</span> <span class="n">ALS</span>
<span class="ln"> 6</span><span class="kn">import</span> <span class="nn">math</span>
<span class="ln"> 7</span>
<span class="ln"> 8</span><span class="n">seed</span> <span class="o">=</span> <span class="mi">5</span><span class="n">L</span>
<span class="ln"> 9</span><span class="n">iterations</span> <span class="o">=</span> <span class="mi">10</span>
<span class="ln">10</span><span class="n">regularization_parameter</span> <span class="o">=</span> <span class="mf">0.1</span>
<span class="ln">11</span><span class="n">ranks</span> <span class="o">=</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">12</span><span class="p">]</span>
<span class="ln">12</span><span class="n">errors</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
<span class="ln">13</span><span class="n">err</span> <span class="o">=</span> <span class="mi">0</span>
<span class="ln">14</span><span class="n">tolerance</span> <span class="o">=</span> <span class="mf">0.02</span>
<span class="ln">15</span>
<span class="ln">16</span><span class="n">min_error</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
<span class="ln">17</span><span class="n">best_rank</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
<span class="ln">18</span><span class="n">best_iteration</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
<span class="ln">19</span><span class="k">for</span> <span class="n">rank</span> <span class="ow">in</span> <span class="n">ranks</span><span class="p">:</span>
<span class="ln">20</span>    <span class="n">model</span> <span class="o">=</span> <span class="n">ALS</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">training_RDD</span><span class="p">,</span> <span class="n">rank</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">,</span> <span class="n">iterations</span><span class="o">=</span><span class="n">iterations</span><span class="p">,</span>
<span class="ln">21</span>                      <span class="n">lambda_</span><span class="o">=</span><span class="n">regularization_parameter</span><span class="p">)</span>
<span class="ln">22</span>    <span class="n">predictions</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predictAll</span><span class="p">(</span><span class="n">validation_for_predict_RDD</span><span class="p">)</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">r</span><span class="p">:</span> <span class="p">((</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">r</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
<span class="ln">23</span>    <span class="n">rates_and_preds</span> <span class="o">=</span> <span class="n">validation_RDD</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">r</span><span class="p">:</span> <span class="p">((</span><span class="nb">int</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">])),</span> <span class="nb">float</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">2</span><span class="p">])))</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">predictions</span><span class="p">)</span>
<span class="ln">24</span>    <span class="n">error</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">rates_and_preds</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">r</span><span class="p">:</span> <span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
<span class="ln">25</span>    <span class="n">errors</span><span class="p">[</span><span class="n">err</span><span class="p">]</span> <span class="o">=</span> <span class="n">error</span>
<span class="ln">26</span>    <span class="n">err</span> <span class="o">+=</span> <span class="mi">1</span>
<span class="ln">27</span>    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;For rank </span><span class="si">%s</span><span class="s1"> the RMSE is </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">rank</span><span class="p">,</span> <span class="n">error</span><span class="p">))</span>
<span class="ln">28</span>    <span class="k">if</span> <span class="n">error</span> <span class="o">&lt;</span> <span class="n">min_error</span><span class="p">:</span>
<span class="ln">29</span>        <span class="n">min_error</span> <span class="o">=</span> <span class="n">error</span>
<span class="ln">30</span>        <span class="n">best_rank</span> <span class="o">=</span> <span class="n">rank</span>
<span class="ln">31</span>
<span class="ln">32</span><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;The best model was trained with rank </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">best_rank</span><span class="p">)</span>
</code></pre></div><p>Kết quả sau khi thực hiện đoạn code trên là:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="ln">1</span><span class="n">For</span> <span class="n">rank</span> <span class="mi">4</span> <span class="n">the</span> <span class="n">RMSE</span> <span class="ow">is</span> <span class="mf">0.963681878574</span>
<span class="ln">2</span><span class="n">For</span> <span class="n">rank</span> <span class="mi">8</span> <span class="n">the</span> <span class="n">RMSE</span> <span class="ow">is</span> <span class="mf">0.96250475933</span>
<span class="ln">3</span><span class="n">For</span> <span class="n">rank</span> <span class="mi">12</span> <span class="n">the</span> <span class="n">RMSE</span> <span class="ow">is</span> <span class="mf">0.971647563632</span>
<span class="ln">4</span><span class="n">The</span> <span class="n">best</span> <span class="n">model</span> <span class="n">was</span> <span class="n">trained</span> <span class="k">with</span> <span class="n">rank</span> <span class="mi">8</span>
</code></pre></div><p>Tiến hành thực hiện test.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="ln">1</span><span class="n">model_test</span> <span class="o">=</span> <span class="n">ALS</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">training_RDD</span><span class="p">,</span> <span class="n">best_rank</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">,</span> <span class="n">iterations</span><span class="o">=</span><span class="n">iterations</span><span class="p">,</span>
<span class="ln">2</span>                      <span class="n">lambda_</span><span class="o">=</span><span class="n">regularization_parameter</span><span class="p">)</span>
<span class="ln">3</span><span class="n">predictions</span> <span class="o">=</span> <span class="n">model_test</span><span class="o">.</span><span class="n">predictAll</span><span class="p">(</span><span class="n">test_for_predict_RDD</span><span class="p">)</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">r</span><span class="p">:</span> <span class="p">((</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">r</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
<span class="ln">4</span><span class="n">rates_and_preds</span> <span class="o">=</span> <span class="n">test_RDD</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">r</span><span class="p">:</span> <span class="p">((</span><span class="nb">int</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">])),</span> <span class="nb">float</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">2</span><span class="p">])))</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">predictions</span><span class="p">)</span>
<span class="ln">5</span><span class="n">error</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">rates_and_preds</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">r</span><span class="p">:</span> <span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
<span class="ln">6</span>    
<span class="ln">7</span><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;For testing data the RMSE is </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">error</span><span class="p">))</span>
</code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="ln">1</span><span class="n">For</span> <span class="n">testing</span> <span class="n">data</span> <span class="n">the</span> <span class="n">RMSE</span> <span class="ow">is</span> <span class="mf">0.972342381898</span>
</code></pre></div><p>Xem kỹ hơn một chút về dữ liệu mà spark trả về cho chúng ta. Với predictions và rates_and_preds, ta có:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="ln">1</span><span class="nb">print</span><span class="p">(</span><span class="n">predictions</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
</code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="ln">1</span><span class="p">[((</span><span class="mi">32</span><span class="p">,</span> <span class="mi">4018</span><span class="p">),</span> <span class="mf">3.280114696166238</span><span class="p">),</span>
<span class="ln">2</span> <span class="p">((</span><span class="mi">375</span><span class="p">,</span> <span class="mi">4018</span><span class="p">),</span> <span class="mf">2.7365714977314086</span><span class="p">),</span>
<span class="ln">3</span> <span class="p">((</span><span class="mi">674</span><span class="p">,</span> <span class="mi">4018</span><span class="p">),</span> <span class="mf">2.510684514310653</span><span class="p">)]</span>
</code></pre></div><p>Tập dữ liệu trả về bao gồm cặp <code>(UserID, MovieID)</code> và <code>Rating</code> (tương ứng với colum 0, column 1 và column 2 ở trên),được hiểu ở đây là với người dùng UserID và phim MovieID thì mô hình sẽ dự đoán người dùng sẽ rating kết quả Rating.</p>
<p>Sau đó chúng ta sẽ nối(join) chúng với tập valid tương ứng theo cặp <code>(UserID, MovieID)</code>, kết quả đạt được là:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="ln">1</span><span class="n">rates_and_preds</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="ln">1</span><span class="p">[((</span><span class="mi">558</span><span class="p">,</span> <span class="mi">788</span><span class="p">),</span> <span class="p">(</span><span class="mf">3.0</span><span class="p">,</span> <span class="mf">3.0419325487471403</span><span class="p">)),</span>
<span class="ln">2</span> <span class="p">((</span><span class="mi">176</span><span class="p">,</span> <span class="mi">3550</span><span class="p">),</span> <span class="p">(</span><span class="mf">4.5</span><span class="p">,</span> <span class="mf">3.3214065001580986</span><span class="p">)),</span>
<span class="ln">3</span> <span class="p">((</span><span class="mi">302</span><span class="p">,</span> <span class="mi">3908</span><span class="p">),</span> <span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">2.4728711204440765</span><span class="p">))]</span>
</code></pre></div><p>Việc còn lại là chúng ta sẽ tính trung bình độ lỗi bằng hàm <code>mean()</code> và <code>sqlt()</code>.</p>
<h2 id="xây-dựng-mô-hình-với-tập-dữ-liệu-large">Xây dựng mô hình với tập dữ liệu large<a class="anchor ms-1" href="#xây-dựng-mô-hình-với-tập-dữ-liệu-large"><i class="fas fa-link"></i></a></h2>
<p>Tiếp theo, chúng ta sẽ sử dụng tập dự liệu bự hơn để xây dựng mô hình. Cách thực hiện y chang như tập dữ liệu nhỏ đã được trình bày ở trên, nên tôi sẽ bỏ qua một số giải thích không cần thiết để tránh lặp lại.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="ln"> 1</span><span class="c1"># Load the complete dataset file</span>
<span class="ln"> 2</span><span class="n">complete_ratings_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">datasets_path</span><span class="p">,</span> <span class="s1">&#39;ml-latest&#39;</span><span class="p">,</span> <span class="s1">&#39;ratings.csv&#39;</span><span class="p">)</span>
<span class="ln"> 3</span><span class="n">complete_ratings_raw_data</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">textFile</span><span class="p">(</span><span class="n">complete_ratings_file</span><span class="p">)</span>
<span class="ln"> 4</span><span class="n">complete_ratings_raw_data_header</span> <span class="o">=</span> <span class="n">complete_ratings_raw_data</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="ln"> 5</span>
<span class="ln"> 6</span><span class="c1"># Parse</span>
<span class="ln"> 7</span><span class="n">complete_ratings_data</span> <span class="o">=</span> <span class="n">complete_ratings_raw_data</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">line</span><span class="p">:</span> <span class="n">line</span><span class="o">!=</span><span class="n">complete_ratings_raw_data_header</span><span class="p">)</span>\
<span class="ln"> 8</span>    <span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">line</span><span class="p">:</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&#34;,&#34;</span><span class="p">))</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">tokens</span><span class="p">:</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="nb">int</span><span class="p">(</span><span class="n">tokens</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span><span class="nb">float</span><span class="p">(</span><span class="n">tokens</span><span class="p">[</span><span class="mi">2</span><span class="p">])))</span><span class="o">.</span><span class="n">cache</span><span class="p">()</span>
<span class="ln"> 9</span>    
<span class="ln">10</span><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;There are </span><span class="si">%s</span><span class="s2"> recommendations in the complete dataset&#34;</span> <span class="o">%</span> <span class="p">(</span><span class="n">complete_ratings_data</span><span class="o">.</span><span class="n">count</span><span class="p">()))</span>
</code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="ln">1</span><span class="n">There</span> <span class="n">are</span> <span class="mi">21063128</span> <span class="n">recommendations</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">complete</span> <span class="n">dataset</span>
</code></pre></div><p>Tiến hành train và test.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="ln"> 1</span><span class="n">training_RDD</span><span class="p">,</span> <span class="n">test_RDD</span> <span class="o">=</span> <span class="n">complete_ratings_data</span><span class="o">.</span><span class="n">randomSplit</span><span class="p">([</span><span class="mi">7</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="n">seed</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="ln"> 2</span>
<span class="ln"> 3</span><span class="n">complete_model</span> <span class="o">=</span> <span class="n">ALS</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">training_RDD</span><span class="p">,</span> <span class="n">best_rank</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">,</span><span class="n">iterations</span><span class="o">=</span><span class="n">iterations</span><span class="p">,</span> <span class="n">lambda_</span><span class="o">=</span><span class="n">regularization_parameter</span><span class="p">)</span>
<span class="ln"> 4</span>
<span class="ln"> 5</span><span class="n">test_for_predict_RDD</span> <span class="o">=</span> <span class="n">test_RDD</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
<span class="ln"> 6</span>
<span class="ln"> 7</span><span class="n">predictions</span> <span class="o">=</span> <span class="n">complete_model</span><span class="o">.</span><span class="n">predictAll</span><span class="p">(</span><span class="n">test_for_predict_RDD</span><span class="p">)</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">r</span><span class="p">:</span> <span class="p">((</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">r</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
<span class="ln"> 8</span><span class="n">rates_and_preds</span> <span class="o">=</span> <span class="n">test_RDD</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">r</span><span class="p">:</span> <span class="p">((</span><span class="nb">int</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">])),</span> <span class="nb">float</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">2</span><span class="p">])))</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">predictions</span><span class="p">)</span>
<span class="ln"> 9</span><span class="n">error</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">rates_and_preds</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">r</span><span class="p">:</span> <span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
<span class="ln">10</span>    
<span class="ln">11</span><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;For testing data the RMSE is </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">error</span><span class="p">))</span>
</code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="ln">1</span><span class="n">For</span> <span class="n">testing</span> <span class="n">data</span> <span class="n">the</span> <span class="n">RMSE</span> <span class="ow">is</span> <span class="mf">0.82183583368</span>
</code></pre></div><h3 id="xây-dựng-mô-hình-dự-đoán-phim">Xây dựng mô hình dự đoán phim<a class="anchor ms-1" href="#xây-dựng-mô-hình-dự-đoán-phim"><i class="fas fa-link"></i></a></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="ln"> 1</span><span class="n">complete_movies_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">datasets_path</span><span class="p">,</span> <span class="s1">&#39;ml-latest&#39;</span><span class="p">,</span> <span class="s1">&#39;movies.csv&#39;</span><span class="p">)</span>
<span class="ln"> 2</span><span class="n">complete_movies_raw_data</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">textFile</span><span class="p">(</span><span class="n">complete_movies_file</span><span class="p">)</span>
<span class="ln"> 3</span><span class="n">complete_movies_raw_data_header</span> <span class="o">=</span> <span class="n">complete_movies_raw_data</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="ln"> 4</span>
<span class="ln"> 5</span><span class="c1"># Parse</span>
<span class="ln"> 6</span><span class="n">complete_movies_data</span> <span class="o">=</span> <span class="n">complete_movies_raw_data</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">line</span><span class="p">:</span> <span class="n">line</span><span class="o">!=</span><span class="n">complete_movies_raw_data_header</span><span class="p">)</span>\
<span class="ln"> 7</span>    <span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">line</span><span class="p">:</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&#34;,&#34;</span><span class="p">))</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">tokens</span><span class="p">:</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="n">tokens</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">tokens</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span><span class="o">.</span><span class="n">cache</span><span class="p">()</span>
<span class="ln"> 8</span>
<span class="ln"> 9</span><span class="n">complete_movies_titles</span> <span class="o">=</span> <span class="n">complete_movies_data</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
<span class="ln">10</span>    
<span class="ln">11</span><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;There are </span><span class="si">%s</span><span class="s2"> movies in the complete dataset&#34;</span> <span class="o">%</span> <span class="p">(</span><span class="n">complete_movies_titles</span><span class="o">.</span><span class="n">count</span><span class="p">()))</span>
</code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="ln">1</span><span class="n">There</span> <span class="n">are</span> <span class="mi">27303</span> <span class="n">movies</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">complete</span> <span class="n">dataset</span>
</code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="ln">1</span><span class="k">def</span> <span class="nf">get_counts_and_averages</span><span class="p">(</span><span class="n">ID_and_ratings_tuple</span><span class="p">):</span>
<span class="ln">2</span>    <span class="n">nratings</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ID_and_ratings_tuple</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="ln">3</span>    <span class="k">return</span> <span class="n">ID_and_ratings_tuple</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="n">nratings</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">ID_and_ratings_tuple</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span><span class="o">/</span><span class="n">nratings</span><span class="p">)</span>
<span class="ln">4</span>
<span class="ln">5</span><span class="n">movie_ID_with_ratings_RDD</span> <span class="o">=</span> <span class="p">(</span><span class="n">complete_ratings_data</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span><span class="o">.</span><span class="n">groupByKey</span><span class="p">())</span>
<span class="ln">6</span><span class="n">movie_ID_with_avg_ratings_RDD</span> <span class="o">=</span> <span class="n">movie_ID_with_ratings_RDD</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">get_counts_and_averages</span><span class="p">)</span>
<span class="ln">7</span><span class="n">movie_rating_counts_RDD</span> <span class="o">=</span> <span class="n">movie_ID_with_avg_ratings_RDD</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span>
</code></pre></div><p>Giả sử chúng ta có 1 người dùng mới, với các ratting như sau:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="ln"> 1</span><span class="n">new_user_ID</span> <span class="o">=</span> <span class="mi">0</span>
<span class="ln"> 2</span>
<span class="ln"> 3</span><span class="c1"># The format of each line is (userID, movieID, rating)</span>
<span class="ln"> 4</span><span class="n">new_user_ratings</span> <span class="o">=</span> <span class="p">[</span>
<span class="ln"> 5</span>     <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">260</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span> <span class="c1"># Star Wars (1977)</span>
<span class="ln"> 6</span>     <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="c1"># Toy Story (1995)</span>
<span class="ln"> 7</span>     <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">16</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="c1"># Casino (1995)</span>
<span class="ln"> 8</span>     <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">25</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span> <span class="c1"># Leaving Las Vegas (1995)</span>
<span class="ln"> 9</span>     <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">32</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span> <span class="c1"># Twelve Monkeys (a.k.a. 12 Monkeys) (1995)</span>
<span class="ln">10</span>     <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">335</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="c1"># Flintstones, The (1994)</span>
<span class="ln">11</span>     <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">379</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="c1"># Timecop (1994)</span>
<span class="ln">12</span>     <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">296</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="c1"># Pulp Fiction (1994)</span>
<span class="ln">13</span>     <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">858</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span> <span class="p">,</span> <span class="c1"># Godfather, The (1972)</span>
<span class="ln">14</span>     <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">50</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span> <span class="c1"># Usual Suspects, The (1995)</span>
<span class="ln">15</span>    <span class="p">]</span>
<span class="ln">16</span><span class="n">new_user_ratings_RDD</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">parallelize</span><span class="p">(</span><span class="n">new_user_ratings</span><span class="p">)</span>
<span class="ln">17</span><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;New user ratings: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">new_user_ratings_RDD</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
</code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="ln">1</span><span class="n">New</span> <span class="n">user</span> <span class="n">ratings</span><span class="p">:</span> <span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">260</span><span class="p">,</span> <span class="mi">9</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">7</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">9</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">335</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">379</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">296</span><span class="p">,</span> <span class="mi">7</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">858</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">8</span><span class="p">)]</span>
</code></pre></div><p>Chúng ta tiến hành huấn luyện lại mô hình khi có thêm người mới:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="ln"> 1</span><span class="n">complete_data_with_new_ratings_RDD</span> <span class="o">=</span> <span class="n">complete_ratings_data</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">new_user_ratings_RDD</span><span class="p">)</span>
<span class="ln"> 2</span>
<span class="ln"> 3</span><span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">time</span>
<span class="ln"> 4</span>
<span class="ln"> 5</span><span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
<span class="ln"> 6</span><span class="n">new_ratings_model</span> <span class="o">=</span> <span class="n">ALS</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">complete_data_with_new_ratings_RDD</span><span class="p">,</span> <span class="n">best_rank</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">,</span> 
<span class="ln"> 7</span>                              <span class="n">iterations</span><span class="o">=</span><span class="n">iterations</span><span class="p">,</span> <span class="n">lambda_</span><span class="o">=</span><span class="n">regularization_parameter</span><span class="p">)</span>
<span class="ln"> 8</span><span class="n">tt</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span>
<span class="ln"> 9</span>
<span class="ln">10</span><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;New model trained in </span><span class="si">%s</span><span class="s2"> seconds&#34;</span> <span class="o">%</span> <span class="nb">round</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
<span class="ln">11</span>
</code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="ln">1</span><span class="n">New</span> <span class="n">model</span> <span class="n">trained</span> <span class="ow">in</span> <span class="mf">56.61</span> <span class="n">seconds</span>
</code></pre></div><p>Tiến hành dự đoán ratting của người dùng mới cho toàn bộ các phim người dùng đó chưa xem.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="ln">1</span><span class="n">new_user_ratings_ids</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">new_user_ratings</span><span class="p">)</span> <span class="c1"># get just movie IDs</span>
<span class="ln">2</span><span class="c1"># keep just those not on the ID list (thanks Lei Li for spotting the error!)</span>
<span class="ln">3</span><span class="n">new_user_unrated_movies_RDD</span> <span class="o">=</span> <span class="p">(</span><span class="n">complete_movies_data</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">new_user_ratings_ids</span><span class="p">)</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">new_user_ID</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
<span class="ln">4</span>
<span class="ln">5</span><span class="c1"># Use the input RDD, new_user_unrated_movies_RDD, with new_ratings_model.predictAll() to predict new ratings for the movies</span>
<span class="ln">6</span><span class="n">new_user_recommendations_RDD</span> <span class="o">=</span> <span class="n">new_ratings_model</span><span class="o">.</span><span class="n">predictAll</span><span class="p">(</span><span class="n">new_user_unrated_movies_RDD</span><span class="p">)</span>
</code></pre></div><p>Và show ra top 3 kết quả :</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="ln">1</span><span class="c1"># Transform new_user_recommendations_RDD into pairs of the form (Movie ID, Predicted Rating)</span>
<span class="ln">2</span><span class="n">new_user_recommendations_rating_RDD</span> <span class="o">=</span> <span class="n">new_user_recommendations_RDD</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">product</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">rating</span><span class="p">))</span>
<span class="ln">3</span><span class="n">new_user_recommendations_rating_title_and_count_RDD</span> <span class="o">=</span> \
<span class="ln">4</span>    <span class="n">new_user_recommendations_rating_RDD</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">complete_movies_titles</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">movie_rating_counts_RDD</span><span class="p">)</span>
<span class="ln">5</span><span class="n">new_user_recommendations_rating_title_and_count_RDD</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</code></pre></div><p>Hiển thị top recommend (Ở đây sẽ flat dữ liệu hiển thị thành dàng <code>((Title, Rating, Ratings Count))</code> ra cho dễ nhìn).</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="ln">1</span><span class="n">new_user_recommendations_rating_title_and_count_RDD</span> <span class="o">=</span> <span class="n">new_user_recommendations_rating_title_and_count_RDD</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">r</span><span class="p">:</span> <span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]))</span>
<span class="ln">2</span>
<span class="ln">3</span><span class="n">top_movies</span> <span class="o">=</span> <span class="n">new_user_recommendations_rating_title_and_count_RDD</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">r</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">&gt;=</span><span class="mi">25</span><span class="p">)</span><span class="o">.</span><span class="n">takeOrdered</span><span class="p">(</span><span class="mi">25</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="o">-</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="ln">4</span>
<span class="ln">5</span><span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;TOP recommended movies (with more than 25 reviews):</span><span class="se">\n</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span>
<span class="ln">6</span>        <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">top_movies</span><span class="p">)))</span>
<span class="ln">7</span>
</code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="ln"> 1</span><span class="n">TOP</span> <span class="n">recommended</span> <span class="n">movies</span> <span class="p">(</span><span class="k">with</span> <span class="n">more</span> <span class="n">than</span> <span class="mi">25</span> <span class="n">reviews</span><span class="p">):</span>
<span class="ln"> 2</span>    <span class="p">(</span><span class="sa">u</span><span class="s1">&#39;&#34;Godfather: Part II&#39;</span><span class="p">,</span> <span class="mf">8.503749129186701</span><span class="p">,</span> <span class="mi">29198</span><span class="p">)</span>
<span class="ln"> 3</span>    <span class="p">(</span><span class="sa">u</span><span class="s1">&#39;&#34;Civil War&#39;</span><span class="p">,</span> <span class="mf">8.386497469089297</span><span class="p">,</span> <span class="mi">257</span><span class="p">)</span>
<span class="ln"> 4</span>    <span class="p">(</span><span class="sa">u</span><span class="s1">&#39;Frozen Planet (2011)&#39;</span><span class="p">,</span> <span class="mf">8.372705479107108</span><span class="p">,</span> <span class="mi">31</span><span class="p">)</span>
<span class="ln"> 5</span>    <span class="p">(</span><span class="sa">u</span><span class="s1">&#39;&#34;Shawshank Redemption&#39;</span><span class="p">,</span> <span class="mf">8.258510064442426</span><span class="p">,</span> <span class="mi">67741</span><span class="p">)</span>
<span class="ln"> 6</span>    <span class="p">(</span><span class="sa">u</span><span class="s1">&#39;Cosmos (1980)&#39;</span><span class="p">,</span> <span class="mf">8.252254825768972</span><span class="p">,</span> <span class="mi">948</span><span class="p">)</span>
<span class="ln"> 7</span>    <span class="p">(</span><span class="sa">u</span><span class="s1">&#39;Band of Brothers (2001)&#39;</span><span class="p">,</span> <span class="mf">8.225114960311624</span><span class="p">,</span> <span class="mi">4450</span><span class="p">)</span>
<span class="ln"> 8</span>    <span class="p">(</span><span class="sa">u</span><span class="s1">&#39;Generation Kill (2008)&#39;</span><span class="p">,</span> <span class="mf">8.206487040524653</span><span class="p">,</span> <span class="mi">52</span><span class="p">)</span>
<span class="ln"> 9</span>    <span class="p">(</span><span class="sa">u</span><span class="s2">&#34;Schindler&#39;s List (1993)&#34;</span><span class="p">,</span> <span class="mf">8.172761674773625</span><span class="p">,</span> <span class="mi">53609</span><span class="p">)</span>
<span class="ln">10</span>    <span class="p">(</span><span class="sa">u</span><span class="s1">&#39;Dr. Strangelove or: How I Learned to Stop Worrying and Love the Bomb (1964)&#39;</span><span class="p">,</span> <span class="mf">8.166229786764168</span><span class="p">,</span> <span class="mi">23915</span><span class="p">)</span>
<span class="ln">11</span>    <span class="p">(</span><span class="sa">u</span><span class="s2">&#34;One Flew Over the Cuckoo&#39;s Nest (1975)&#34;</span><span class="p">,</span> <span class="mf">8.15617022970577</span><span class="p">,</span> <span class="mi">32948</span><span class="p">)</span>
<span class="ln">12</span>    <span class="p">(</span><span class="sa">u</span><span class="s1">&#39;Casablanca (1942)&#39;</span><span class="p">,</span> <span class="mf">8.141303207981174</span><span class="p">,</span> <span class="mi">26114</span><span class="p">)</span>
<span class="ln">13</span>    <span class="p">(</span><span class="sa">u</span><span class="s1">&#39;Seven Samurai (Shichinin no samurai) (1954)&#39;</span><span class="p">,</span> <span class="mf">8.139633165142612</span><span class="p">,</span> <span class="mi">11796</span><span class="p">)</span>
<span class="ln">14</span>    <span class="p">(</span><span class="sa">u</span><span class="s1">&#39;Goodfellas (1990)&#39;</span><span class="p">,</span> <span class="mf">8.12931139039048</span><span class="p">,</span> <span class="mi">27123</span><span class="p">)</span>
<span class="ln">15</span>    <span class="p">(</span><span class="sa">u</span><span class="s1">&#39;Star Wars: Episode V - The Empire Strikes Back (1980)&#39;</span><span class="p">,</span> <span class="mf">8.124225700242096</span><span class="p">,</span> <span class="mi">47710</span><span class="p">)</span>
<span class="ln">16</span>    <span class="p">(</span><span class="sa">u</span><span class="s1">&#39;Jazz (2001)&#39;</span><span class="p">,</span> <span class="mf">8.078538221315313</span><span class="p">,</span> <span class="mi">25</span><span class="p">)</span>
<span class="ln">17</span>    <span class="p">(</span><span class="sa">u</span><span class="s2">&#34;Long Night&#39;s Journey Into Day (2000)&#34;</span><span class="p">,</span> <span class="mf">8.050176820606127</span><span class="p">,</span> <span class="mi">34</span><span class="p">)</span>
<span class="ln">18</span>    <span class="p">(</span><span class="sa">u</span><span class="s1">&#39;Lawrence of Arabia (1962)&#39;</span><span class="p">,</span> <span class="mf">8.041331489948814</span><span class="p">,</span> <span class="mi">13452</span><span class="p">)</span>
<span class="ln">19</span>    <span class="p">(</span><span class="sa">u</span><span class="s1">&#39;Raiders of the Lost Ark (Indiana Jones and the Raiders of the Lost Ark) (1981)&#39;</span><span class="p">,</span> <span class="mf">8.0399424815528</span><span class="p">,</span> <span class="mi">45908</span><span class="p">)</span>
<span class="ln">20</span>    <span class="p">(</span><span class="sa">u</span><span class="s1">&#39;12 Angry Men (1957)&#39;</span><span class="p">,</span> <span class="mf">8.011389274280754</span><span class="p">,</span> <span class="mi">13235</span><span class="p">)</span>
<span class="ln">21</span>    <span class="p">(</span><span class="sa">u</span><span class="s2">&#34;It&#39;s Such a Beautiful Day (2012)&#34;</span><span class="p">,</span> <span class="mf">8.007734839026181</span><span class="p">,</span> <span class="mi">35</span><span class="p">)</span>
<span class="ln">22</span>    <span class="p">(</span><span class="sa">u</span><span class="s1">&#39;Apocalypse Now (1979)&#39;</span><span class="p">,</span> <span class="mf">8.005094327199552</span><span class="p">,</span> <span class="mi">23905</span><span class="p">)</span>
<span class="ln">23</span>    <span class="p">(</span><span class="sa">u</span><span class="s1">&#39;Paths of Glory (1957)&#39;</span><span class="p">,</span> <span class="mf">7.999379786394267</span><span class="p">,</span> <span class="mi">3598</span><span class="p">)</span>
<span class="ln">24</span>    <span class="p">(</span><span class="sa">u</span><span class="s1">&#39;Rear Window (1954)&#39;</span><span class="p">,</span> <span class="mf">7.9860865203540214</span><span class="p">,</span> <span class="mi">17996</span><span class="p">)</span>
<span class="ln">25</span>    <span class="p">(</span><span class="sa">u</span><span class="s1">&#39;State of Play (2003)&#39;</span><span class="p">,</span> <span class="mf">7.981582126801772</span><span class="p">,</span> <span class="mi">27</span><span class="p">)</span>
<span class="ln">26</span>    <span class="p">(</span><span class="sa">u</span><span class="s1">&#39;Chinatown (1974)&#39;</span><span class="p">,</span> <span class="mf">7.978673289692703</span><span class="p">,</span> <span class="mi">16195</span><span class="p">)</span>
</code></pre></div><h2 id="dự-đoán-rating-của-1-cá-nhân">Dự đoán rating của 1 cá nhân<a class="anchor ms-1" href="#dự-đoán-rating-của-1-cá-nhân"><i class="fas fa-link"></i></a></h2>
<p>Một trường hợp khác là chúng ta cần dự đoán giá trị ratting của 1 người dùng với 1 bộ phim cụ thể nào đó.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="ln">1</span><span class="n">my_movie</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">parallelize</span><span class="p">([(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">500</span><span class="p">)])</span> <span class="c1"># Quiz Show (1994)</span>
<span class="ln">2</span><span class="n">individual_movie_rating_RDD</span> <span class="o">=</span> <span class="n">new_ratings_model</span><span class="o">.</span><span class="n">predictAll</span><span class="p">(</span><span class="n">new_user_unrated_movies_RDD</span><span class="p">)</span>
<span class="ln">3</span><span class="n">individual_movie_rating_RDD</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="ln">1</span><span class="p">[</span><span class="n">Rating</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">product</span><span class="o">=</span><span class="mi">122880</span><span class="p">,</span> <span class="n">rating</span><span class="o">=</span><span class="mf">4.955831875971526</span><span class="p">)]</span>
</code></pre></div><h2 id="lưu-trữ-mô-hình">Lưu trữ mô hình<a class="anchor ms-1" href="#lưu-trữ-mô-hình"><i class="fas fa-link"></i></a></h2>
<p>Sau khi có được mô hình. Chúng ta cần phải lưu trữ chúng lại để sau này dùng.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="ln">1</span><span class="kn">from</span> <span class="nn">pyspark.mllib.recommendation</span> <span class="kn">import</span> <span class="n">MatrixFactorizationModel</span>
<span class="ln">2</span>
<span class="ln">3</span><span class="n">model_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;models&#39;</span><span class="p">,</span> <span class="s1">&#39;movie_lens_als&#39;</span><span class="p">)</span>
<span class="ln">4</span>
<span class="ln">5</span><span class="c1"># Save and load model</span>
<span class="ln">6</span><span class="n">model</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">model_path</span><span class="p">)</span>
<span class="ln">7</span><span class="n">same_model</span> <span class="o">=</span> <span class="n">MatrixFactorizationModel</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">model_path</span><span class="p">)</span>
<span class="ln">8</span>
</code></pre></div></div></div>
  <div class="card-footer"><div class="post-navs d-flex justify-content-evenly"><div class="post-nav post-prev">
    <i class="fas fa-fw fa-chevron-left"></i>
    <a href="/blog/2018-06-15-understanding-alexnet/">Tìm Hiểu Về Mạng Neural Network AlexNet
</a>
  </div><div class="post-nav post-next">
    <a href="/blog/2018-10-02-understanding-epoch-batchsize-iterations/">Phân Biệt Epoch - Batch Size Và Iterations
</a>
    <i class="fas fa-fw fa-chevron-right"></i>
  </div></div></div>
</article><div class="card component row post-comments" id="post-comments">
  <div class="card-header">
    <h2 class="card-title">Comments</h2>
  </div>
  <div class="card-body"><script src="https://utteranc.es/client.js"
  repo="AlexBlack2202/utterances"
  issue-term="pathname"
  label="comment"
  theme="github-light"
  crossorigin="anonymous"
  async>
</script></div>
</div></div>
</div><aside class="col-lg-4 sidebar d-flex">
  <div class="container d-flex flex-column">
    
    <section class="card row text-center profile component">
  <div class="card-body">
    <div class="col-12 d-flex align-items-center justify-content-center"><img class="profile-avatar rounded-circle" alt="Đặng Thị Hằng | Phạm Duy Tùng" src="/images/profile.webp" loading="lazy"
   width="736" height="920"
   />
</div>
    <div class="col-12 profile-meta"><div class="profile-name">Đặng Thị Hằng | Phạm Duy Tùng</div><div class="profile-bio">Gopher, CShaper, Pythoner, Full Stack Engineer.</div><div class="profile-company"><i class="fas fa-fw fa-building"></i>MWG</div><div class="profile-location"><i class="fas fa-fw fa-map-marker-alt"></i>Earth</div><div class="profile-about"><i class="fas fa-fw fa-user"></i><a href="/about/">About</a></div><div class="profile-contact"><i class="fas fa-fw fa-question-circle"></i><a href="/contact/">Contact Us</a></div>
</div>
  </div>
</section>
  <div class="post-toc row mb-4 card component" id="postTOC">
  <div class="card-header">
    <h2 class="card-title">Contents</h2>
  </div>
  <div class="card-body">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#lời-mở-đầu">Lời mở đầu</a></li>
    <li><a href="#chuẩn-bị-dữ-liệu">Chuẩn bị dữ liệu</a></li>
    <li><a href="#loading-và-parsing-dữ-liệu">Loading và parsing dữ liệu.</a></li>
    <li><a href="#collaborative-filtering">Collaborative Filtering</a></li>
    <li><a href="#chọn-các-tham-số-cho-als">Chọn các tham số cho ALS</a></li>
    <li><a href="#xây-dựng-mô-hình-với-tập-dữ-liệu-large">Xây dựng mô hình với tập dữ liệu large</a>
      <ul>
        <li><a href="#xây-dựng-mô-hình-dự-đoán-phim">Xây dựng mô hình dự đoán phim</a></li>
      </ul>
    </li>
    <li><a href="#dự-đoán-rating-của-1-cá-nhân">Dự đoán rating của 1 cá nhân</a></li>
    <li><a href="#lưu-trữ-mô-hình">Lưu trữ mô hình</a></li>
  </ul>
</nav>
  </div>
</div><section class="recent-posts row card component">
  <div class="card-header">
    <h2 class="card-title">Recent Posts</h2>
  </div>
  <div class="card-body">
    <ul class="post-list"><li>
        <a href="/blog/2022-02-25-normalization/">Các Kỹ Thuật Chuẩn Hóa Trong Deep Learning
</a>
      </li><li>
        <a href="/blog/2021-11-06-some-way-make-momey-from-web-scrapping/">Một Số Cách Kiếm Thêm Thu Nhập Từ Cách Cào Dữ Liệu
</a>
      </li><li>
        <a href="/blog/2021-08-12-china_chess_alpha_beta_ai/">Xây Dựng Chương Trình AI Đơn Giản Cho Game Cờ Tướng
</a>
      </li><li>
        <a href="/blog/2021-07-28-pycaret-flaskapi/">Tìm Hiểu Package PyCaret Trong Python
</a>
      </li><li>
        <a href="/blog/2021-07-02-mo-hinh-phan-quyen/">Mô Hình Phân Quyền - Access Control
</a>
      </li></ul>
  </div>
</section><section class="series-taxonomies row card component">
      <div class="card-header">
        <h2 class="card-title">
          <a href="/series">Series</a>
        </h2>
      </div>
      <div class="card-body">
        <div class="py-2"><a href="/series/kh%C3%B3a-h%E1%BB%8Dc-c&#43;&#43;-c%C4%83n-b%E1%BA%A3n/" class="badge rounded post-taxonomy" title="Khóa học c&#43;&#43; căn bản">
            Khóa học c&#43;&#43; căn bản<span class="badge badge-sm text-white bg-accent ms-1">3</span></a><a href="/series/machine-learning-dataset/" class="badge rounded post-taxonomy" title="Machine learning dataset">
            Machine learning dataset<span class="badge badge-sm text-white bg-accent ms-1">2</span></a><a href="/series/tools/" class="badge rounded post-taxonomy" title="tools">
            tools<span class="badge badge-sm text-white bg-accent ms-1">2</span></a><a href="/series/kh%C3%B3a-h%E1%BB%8Dc-python-c%C4%83n-b%E1%BA%A3n/" class="badge rounded post-taxonomy" title="Khóa học python căn bản">
            Khóa học python căn bản<span class="badge badge-sm text-white bg-accent ms-1">1</span></a></div>
      </div>
    </section><section class="categories-taxonomies row card component">
      <div class="card-header">
        <h2 class="card-title">
          <a href="/categories">Categories</a>
        </h2>
      </div>
      <div class="card-body">
        <div class="py-2"><a href="/categories/c&#43;&#43;/" class="badge rounded post-taxonomy" title="c&#43;&#43;">
            c&#43;&#43;<span class="badge badge-sm text-white bg-accent ms-1">3</span></a><a href="/categories/dataset/" class="badge rounded post-taxonomy" title="dataset">
            dataset<span class="badge badge-sm text-white bg-accent ms-1">2</span></a><a href="/categories/python/" class="badge rounded post-taxonomy" title="python">
            python<span class="badge badge-sm text-white bg-accent ms-1">1</span></a></div>
      </div>
    </section><section class="tags-taxonomies row card component">
      <div class="card-header">
        <h2 class="card-title">
          <a href="/tags">Tags</a>
        </h2>
      </div>
      <div class="card-body">
        <div class="py-2"><a href="/tags/machine-learning/" class="badge rounded post-taxonomy" title="Machine learning">
            Machine learning<span class="badge badge-sm text-white bg-accent ms-1">39</span></a><a href="/tags/deeplearning/" class="badge rounded post-taxonomy" title="Deeplearning">
            Deeplearning<span class="badge badge-sm text-white bg-accent ms-1">20</span></a><a href="/tags/deep-learning/" class="badge rounded post-taxonomy" title="Deep learning">
            Deep learning<span class="badge badge-sm text-white bg-accent ms-1">16</span></a><a href="/tags/python/" class="badge rounded post-taxonomy" title="python">
            python<span class="badge badge-sm text-white bg-accent ms-1">10</span></a><a href="/tags/opencv/" class="badge rounded post-taxonomy" title="opencv">
            opencv<span class="badge badge-sm text-white bg-accent ms-1">5</span></a><a href="/tags/c&#43;&#43;/" class="badge rounded post-taxonomy" title="c&#43;&#43;">
            c&#43;&#43;<span class="badge badge-sm text-white bg-accent ms-1">4</span></a><a href="/tags/object-detector/" class="badge rounded post-taxonomy" title="object detector">
            object detector<span class="badge badge-sm text-white bg-accent ms-1">4</span></a><a href="/tags/alexnet/" class="badge rounded post-taxonomy" title="AlexNet">
            AlexNet<span class="badge badge-sm text-white bg-accent ms-1">3</span></a><a href="/tags/d%E1%BB%B1-%C4%91o%C3%A1n/" class="badge rounded post-taxonomy" title="dự đoán">
            dự đoán<span class="badge badge-sm text-white bg-accent ms-1">3</span></a><a href="/tags/forecast/" class="badge rounded post-taxonomy" title="forecast">
            forecast<span class="badge badge-sm text-white bg-accent ms-1">3</span></a></div>
      </div>
    </section>
    
  </div>
</aside>
</div>
    </main><footer class="footer mt-auto py-3 text-center container"><ul class="nav justify-content-between footer-memu mb-3"><li class="nav-item"><ul class="nav flex-column align-items-start">
      <li class="nav-item">
        <a class="nav-link fw-bold" target="_blank" rel="noopener noreferrer">Support
</a>
      </li><li class="nav-item">
            <a class="nav-link" href="https://www.facebook.com/groups/1354425091720104" target="_blank" rel="noopener noreferrer"><i class="fab fa-fw fa-github"></i>Repository
</a>
        </li><li class="nav-item">
            <a class="nav-link" href="https://www.facebook.com/groups/1354425091720104" target="_blank" rel="noopener noreferrer"><i class="fas fa-fw fa-comments"></i>Discussions
</a>
        </li><li class="nav-item">
            <a class="nav-link" href="https://www.facebook.com/groups/1354425091720104" target="_blank" rel="noopener noreferrer">Features Request
</a>
        </li><li class="nav-item">
            <a class="nav-link" href="https://www.facebook.com/groups/1354425091720104" target="_blank" rel="noopener noreferrer">Bug Report
</a>
        </li><li class="nav-item">
            <a class="nav-link" href="/contact/"><i class="fas fa-fw fa-info-circle"></i>Contact Us
</a>
        </li><li class="nav-item">
            <a class="nav-link" href="/faq/"><i class="fas fa-fw fa-question-circle"></i>FAQs
</a>
        </li></ul></li><li class="nav-item"><li class="nav-item">
      <a class="nav-link" target="_blank" rel="noopener noreferrer">Docs
</a>
    </li></li><li class="nav-item"><li class="nav-item">
      <a class="nav-link" target="_blank" rel="noopener noreferrer">Features
</a>
    </li></li><li class="nav-item"><ul class="nav flex-column align-items-start">
      <li class="nav-item">
        <a class="nav-link fw-bold" target="_blank" rel="noopener noreferrer">Demo
</a>
      </li><li class="nav-item">
            <a class="nav-link" href="https://www.facebook.com/groups/1354425091720104" target="_blank" rel="noopener noreferrer">Netlify
</a>
        </li><li class="nav-item">
            <a class="nav-link" href="https://www.facebook.com/groups/1354425091720104" target="_blank" rel="noopener noreferrer">China
</a>
        </li></ul></li></ul>
<div class="copyright mb-2">
  Copyright © 2016-2022 Phạm Duy Tùng. All Rights Reserved.
</div>
<div class="powered-by mb-2">
  Website chia sẻ kiến thức của Phạm Duy Tùng và Đặng Thị Hằng. Vui lòng liên hệ email alexblack2202@gmail.com nếu bạn có thông tin cần trao đổi.
</div></footer>
<script src="/js/main.0f06b653e090cf5f3e595cc4f3150328397d377ee5b405d0803057801eb4f3e5.js" integrity="sha256-Dwa2U&#43;CQz18&#43;WVzE8xUDKDl9N37ltAXQgDBXgB608&#43;U=" crossorigin="anonymous" defer></script><script src="/js/icons.min.8ddcaafc364ff0296c2209c5495287f0de039b852da9b24847f94c198b7639b6.js" integrity="sha256-jdyq/DZP8ClsIgnFSVKH8N4Dm4UtqbJIR/lMGYt2ObY=" crossorigin="anonymous" defer></script>
<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('\/service-worker.js').then(function(reg) {
      console.log('Successfully registered service worker', reg);
    }).catch(function(err) {
      console.warn('Error whilst registering service worker', err);
    });
  });
}
</script><script src="/js/viewer.min.652118a9fbf3403cdfde4026209f97ace22f9e334f0b45a33431a221b3db46a8.js" integrity="sha256-ZSEYqfvzQDzf3kAmIJ&#43;XrOIvnjNPC0WjNDGiIbPbRqg=" crossorigin="anonymous" defer></script><script defer src="/js/katex.min.a575e93a07f02f7e58ee9002aea3b4e75163d4fa8ea3a627e90e7fafd5c718fa.js" integrity="sha256-pXXpOgfwL35Y7pACrqO051Fj1PqOo6Yn6Q5/r9XHGPo=" crossorigin="anonymous"></script>

<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-114911596-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

</body>
</html>
