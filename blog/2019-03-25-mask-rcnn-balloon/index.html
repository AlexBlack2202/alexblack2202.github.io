<!doctype html><html lang="en" data-palette="blue"
   data-mode="dark">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Tìm hiểu Mask R-CNN và ví dụ phân vùng quả bóng bay sử dụng deep learning - Phạm Duy Tùng Machine Learning Blog</title>
    <meta name="a.validate.02" content="1QZXZ8oi7g57H-GxBrBPkTYBydwii-Ic9iJu" /><link rel="apple-touch-icon" href="/images/icons/icon-180x180.png" sizes="180x180">
<link rel="icon" href="/images/icons/icon-32x32.png" sizes="32x32" type="image/png">
<link rel="icon" href="/images/icons/icon-16x16.png" sizes="16x16" type="image/png">
<link rel="icon" href="/images/icons/favicon.ico">
<link rel="manifest" href="/manifest.json">
<meta name="keywords" content="" />
<meta name="description" content="Ở bài viết này, chúng ta sẽ thực hiện phân đoạn ảnh sử dụng Mask R-CNN với tập dữ liệu là những quả bóng bay bảy màu rất đẹp." /><meta name="robots" content="index, follow" />
  <meta itemprop="name" content="Tìm hiểu Mask R-CNN và ví dụ phân vùng quả bóng bay sử dụng deep learning">
  <meta itemprop="description" content="Ở bài viết này, chúng ta sẽ thực hiện phân đoạn ảnh sử dụng Mask R-CNN với tập dữ liệu là những quả bóng bay bảy màu rất đẹp.">
  <meta itemprop="datePublished" content="2019-03-25T00:12:00+03:00">
  <meta itemprop="dateModified" content="2019-03-25T00:12:00+03:00">
  <meta itemprop="wordCount" content="3153">
  <meta itemprop="keywords" content="Machine Learning,Deep Learning,Mask R-CNN,Balloon,Bóng Bay"><meta property="og:url" content="/blog/2019-03-25-mask-rcnn-balloon/">
  <meta property="og:site_name" content="Phạm Duy Tùng Machine Learning Blog">
  <meta property="og:title" content="Tìm hiểu Mask R-CNN và ví dụ phân vùng quả bóng bay sử dụng deep learning">
  <meta property="og:description" content="Ở bài viết này, chúng ta sẽ thực hiện phân đoạn ảnh sử dụng Mask R-CNN với tập dữ liệu là những quả bóng bay bảy màu rất đẹp.">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="blog">
    <meta property="article:published_time" content="2019-03-25T00:12:00+03:00">
    <meta property="article:modified_time" content="2019-03-25T00:12:00+03:00">
    <meta property="article:tag" content="Machine Learning">
    <meta property="article:tag" content="Deep Learning">
    <meta property="article:tag" content="Mask R-CNN">
    <meta property="article:tag" content="Balloon">
    <meta property="article:tag" content="Bóng Bay">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Tìm hiểu Mask R-CNN và ví dụ phân vùng quả bóng bay sử dụng deep learning">
  <meta name="twitter:description" content="Ở bài viết này, chúng ta sẽ thực hiện phân đoạn ảnh sử dụng Mask R-CNN với tập dữ liệu là những quả bóng bay bảy màu rất đẹp.">
<meta property="og:image" content="/images/logo.png"/>
  <meta name="twitter:image" content="/images/logo.png"/><link rel="stylesheet" href="/css/main.min.c06cf34535ee1f60ba08893b4d57e76b2bbd5e11c17ab12ef976f02983a51b54.css" integrity="sha256-wGzzRTXuH2C6CIk7TVfnayu9XhHBerEu&#43;XbwKYOlG1Q=" crossorigin="anonymous"><link rel="stylesheet" href="/css/katex.min.d080a89e03e1eb850f547d835c186b4273f69879aa497eb8b0e88c1578bf1f0b.css" integrity="sha256-0ICongPh64UPVH2DXBhrQnP2mHmqSX64sOiMFXi/Hws=" crossorigin="anonymous">
<link rel="stylesheet" href="/css/viewer.min.3d228794bcedbbfa0412beb8fbc1ec6973202945e42af7004f742a4d7bd620ab.css" integrity="sha256-PSKHlLztu/oEEr64&#43;8HsaXMgKUXkKvcAT3QqTXvWIKs=" crossorigin="anonymous"><style>
    .bgcover {
        display: block;
        overflow: hidden;
        height: 450px;
        background: no-repeat center center;
        -webkit-background-size: cover;
        -moz-background-size: cover;
        -o-background-size: cover;
        background-size: cover;
        position: relative;
        margin-bottom: -65px;
    }
    .bgcover {
        margin-bottom: 0 !important;
    }

    .bgcover .bgtrans {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        display: block;
        overflow: hidden;
        height: inherit;
        background: rgba(0,0,0,.8);
        background: -webkit-gradient(linear,0% 0%,0% 100%,from(rgba(0,0,0,.8)),to (rgba(0,0,0,.6)),to(rgba(255,255,255,0)));
        background: -webkit-linear-gradient(top,rgba(255,255,255,0),rgba(0,0,0,.6),rgba(0,0,0,.8));
        background: -moz-linear-gradient(top,rgba(255,255,255,0),rgba(0,0,0,.6),rgba(0,0,0,.8));
        background: -ms-linear-gradient(top,rgba(255,255,255,0),rgba(0,0,0,.6),rgba(0,0,0,.8));
        background: -o-linear-gradient(top,rgba(255,255,255,0),rgba(0,0,0,.6),rgba(0,0,0,.8));
    }

    .bgcover .bgtrans h1 {
        display: block;
        overflow: hidden;
        font-size: 45px;
        line-height: 55px;
        color: #fff;
        width: 800px;
        margin: auto;
        position: absolute;
        left: 0;
        right: 0;
        bottom: 50px;
        font-family: 'Roboto Condensed',sans-serif;
        font-weight: 600;
    }
</style></head>
  <body><script>const items=["mode","palette"];items.forEach(function(e){const t=localStorage.getItem("hbs-"+e);t&&document.body.parentElement.setAttribute("data-"+e,t)})</script><header><nav class="navbar top-app-bar top-app-bar-expand-lg fixed-top">
  <div class="container">
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent"
      aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <i class="fas fa-bars"></i>
    </button><a class="navbar-brand flex-grow-1 flex-lg-grow-0 text-center text-lg-start mx-auto me-lg-3" href="/"><img class="logo" alt="Logo" src="/images/logo.webp" loading="lazy"  title="Logo"
   width="400" height="400"
   />
HOME
    </a>
    <div class="offcanvas offcanvas-bottom surface" tabindex="-1" id="offcanvasSocialShare" aria-labelledby="offcanvasSocialShare">
  <div class="offcanvas-header">
    <h3 class="offcanvas-title">Share</h3>
    <button type="button" class="btn btn-sm btn-outline-primary" data-bs-dismiss="offcanvas" aria-label="Close">
      <i class="fas fa-times"></i>
    </button>
  </div>
  <div class="offcanvas-body">
    <a class="btn btn-sm btn-outline-primary social-share-button" rel="noopener noreferrer" aria-label="Twitter Share Button"
      target="_blank" href="https://twitter.com/intent/tweet?title=T%c3%acm%20hi%e1%bb%83u%20Mask%20R-CNN%20v%c3%a0%20v%c3%ad%20d%e1%bb%a5%20ph%c3%a2n%20v%c3%b9ng%20qu%e1%ba%a3%20b%c3%b3ng%20bay%20s%e1%bb%ad%20d%e1%bb%a5ng%20deep%20learning&url=%2fblog%2f2019-03-25-mask-rcnn-balloon%2f">
      <i class="fab fa-fw fa-twitter"></i> Twitter
    </a>
    <a class="btn btn-sm btn-outline-primary social-share-button" rel="noopener noreferrer" aria-label="Facebook Share Button"
      target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=%2fblog%2f2019-03-25-mask-rcnn-balloon%2f">
      <i class="fab fa-fw fa-facebook-f"></i> Facebook
    </a>
  </div>
</div>
    <button class="navbar-settings" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasSettings"
  aria-controls="offcanvasSettings" aria-label="Toggle settings">
  <i class="fas fa-ellipsis-v"></i>
</button>

<div class="offcanvas offcanvas-end surface h-100" tabindex="-1" id="offcanvasSettings" aria-labelledby="offcanvasSettings">
  <div class="offcanvas-header">
    <h3 class="offcanvas-title">Settings</h3>
    <button type="button" class="btn btn-sm btn-outline-primary" data-bs-dismiss="offcanvas" aria-label="Close">
      <i class="fas fa-times"></i>
    </button>
  </div>
  <div class="offcanvas-body d-flex flex-column">



<section class="setting">
  <form class="font-size-switcher-form row">
    <div class="col-auto">
      <label for="fontSize" class="form-label"><i class="fas fa-fw fa-font"></i> Font Size</label>
    </div>
    <div class="col-auto ms-auto">
      <input type="range" class="form-range" min="-2" max="2" id="fontSize">
    </div>
  </form>
</section>


<section class="setting palettes">
  <form class="row">
    <div class="col-auto">
      <label><i class="fas fa-fw fa-palette"></i> Palette</label>
    </div>
    <div class="col-auto ms-auto">
      <a id="btnPalette" class="btn btn-sm btn-outline-primary" role="button" aria-label="palettePicker">
        <i class="fas fa-eye-dropper"></i>
      </a>
    </div>
  </form>
  <div class="mt-2 d-flex justify-content-between visually-hidden" id="palettePicker"><button type="button" id="palette-blue" aria-label="Blue"
        class="btn btn-sm w-100 palette" data-palette="blue">
      </button><button type="button" id="palette-blue-gray" aria-label="Blue Gray"
        class="btn btn-sm w-100 palette" data-palette="blue-gray">
      </button><button type="button" id="palette-brown" aria-label="Brown"
        class="btn btn-sm w-100 palette" data-palette="brown">
      </button><button type="button" id="palette-cyan" aria-label="Cyan"
        class="btn btn-sm w-100 palette" data-palette="cyan">
      </button><button type="button" id="palette-green" aria-label="Green"
        class="btn btn-sm w-100 palette" data-palette="green">
      </button><button type="button" id="palette-indigo" aria-label="Indigo"
        class="btn btn-sm w-100 palette" data-palette="indigo">
      </button><button type="button" id="palette-orange" aria-label="Orange"
        class="btn btn-sm w-100 palette" data-palette="orange">
      </button><button type="button" id="palette-pink" aria-label="Pink"
        class="btn btn-sm w-100 palette" data-palette="pink">
      </button><button type="button" id="palette-purple" aria-label="Purple"
        class="btn btn-sm w-100 palette" data-palette="purple">
      </button><button type="button" id="palette-red" aria-label="Red"
        class="btn btn-sm w-100 palette" data-palette="red">
      </button><button type="button" id="palette-teal" aria-label="Teal"
        class="btn btn-sm w-100 palette" data-palette="teal">
      </button><button type="button" id="palette-yellow" aria-label="Yellow"
        class="btn btn-sm w-100 palette" data-palette="yellow">
      </button></div>
</section>
<section class="setting actions d-flex justify-content-around mt-auto overflow-auto">
  <a role="button" class="action action-go-back" href="javascript: window.history.back();">
    <span class="action-icon"><i class="fas fa-2x fa-arrow-left"></i></span> Go back
  </a>
  <a role="button" class="action action-reload-page">
    <span class="action-icon"><i class="fas fa-2x fa-redo-alt"></i></span> Reload
  </a>
  <a role="button" class="action action-copy-url">
    <span class="action-icon"><i class="fas fa-2x fa-link"></i></span> Copy URL
  </a><a class="action action-social-share" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasSocialShare"
    aria-controls="offcanvasSocialShare" aria-label="Toggle social share">
    <span class="action-icon"><i class="fas fa-2x fa-share-alt"></i></span> Share
  </a></section>

</div>
</div>

    <div class="collapse navbar-collapse" tabindex="-1" id="navbarSupportedContent" aria-labelledby="navbarSupportedContent">
      <form class="search-bar my-1" action="/search">
  <div class="input-group input-group-sm">
    <span class="btn btn-search disabled position-absolute left-0"><i class="fas fa-fw fa-search"></i></span>
    <input class="form-control rounded-pill" name="q" type="search" aria-label="Search">
  </div>
</form>
      <ul class="navbar-nav ms-auto"><li class="nav-item">
          <a class="nav-link" href="/series/">
            <i class="fas fa-fw fa-columns"></i>Courses
          </a>
        </li><li class="nav-item">
          <a class="nav-link" href="/tools/">
            <i class="fas fa-fw fa-folder"></i>Tools
          </a>
        </li><li class="nav-item">
          <a class="nav-link" href="/categories/">
            <i class="fas fa-fw fa-folder"></i>Categories
          </a>
        </li><li class="nav-item">
          <a class="nav-link" href="/archives/">
            <i class="fas fa-fw fa-file-archive"></i>Archives
          </a>
        </li><li class="nav-item">
          <a class="nav-link" href="/tags/">
            <i class="fas fa-fw fa-tags"></i>Tags
          </a>
        </li><li class="nav-item dropdown">
          <a class="nav-link" id="navbarDropdownSupport" role="button" data-bs-toggle="dropdown" aria-expanded="false">
            <i class="fas fa-fw fa-chevron-circle-down"></i>Support
          </a>
          <ul class="dropdown-menu" aria-labelledby="navbarDropdownSupport"><li>
              <a class="dropdown-item"
                href="https://www.facebook.com/groups/1354425091720104" target="_blank" rel="noopener noreferrer">
                Repository
              </a>
            </li><li>
              <a class="dropdown-item"
                href="https://www.facebook.com/groups/1354425091720104" target="_blank" rel="noopener noreferrer">
                Discussions
              </a>
            </li><li>
              <a class="dropdown-item"
                href="https://www.facebook.com/groups/1354425091720104" target="_blank" rel="noopener noreferrer">
                Features Request
              </a>
            </li><li><hr class="dropdown-divider"></li><li>
              <a class="dropdown-item"
                href="/faq/">
                FAQs
              </a>
            </li></ul>
        </li></ul>
    </div>
  </div>
</nav>
</header>
<main role="main" class="container" style="line-height:1.7em">
      <div class="row content">
<div class="col-lg-9 col-md-8">
  <div class="container"><nav class="row card component" aria-label="breadcrumb">
  <div class="card-body">
    <ol class="breadcrumb "><li class="breadcrumb-item"><a href="/">Home</a></li><li class="breadcrumb-item"><a href="/blog/">Blogs</a></li><li class="breadcrumb-item active">Tìm Hiểu Mask R-CNN Và Ví Dụ Phân Vùng Quả Bóng Bay Sử Dụng Deep Learning</li></ol>
  </div>
</nav>
<div class="post-panel-wrapper">
  <div class="d-flex flex-column component rounded post-panel">
    
    <a class="action action-panel-toggler" role="button" title="Panel toggler">
      <i class="fas fa-fw fa-chevron-circle-down"></i>
    </a>
    <a id="sidebarToggler" class="action d-none d-lg-block" role="button" title="Sidebar toggler">
  <i class="fas fa-fw fa-expand-alt" data-fa-transform="rotate-45"></i>
</a>

    

    
    
    <a class="action" href="#post-comments" role="button" aria-label="Comments" title="Comments">
  <i class="fas fa-fw fa-comments"></i>
</a>
    <a class="action" href="#postTOC" aria-controls="Table of contents" role="button" title="Table of contents">
  <i class="fas fa-fw fa-list-alt"></i>
</a>
    
  </div>
</div>
<article class="row card component mb-4 post">
  <div class="card-header ">
    <div class="bgcover" style="background-image:url(https://unsplash.it/1920/1080)" alt="Tìm hiểu Mask R-CNN và ví dụ phân vùng quả bóng bay sử dụng deep learning">
      <div class="bgtrans">
          <h1>Tìm Hiểu Mask R-CNN Và Ví Dụ Phân Vùng Quả Bóng Bay Sử Dụng Deep Learning
</h1>
      </div>
  </div>
</div>
  <div class="card-body"><div class="post-meta">
  <span class="post-date" title="created on 2019-03-25 04:12:00 &#43;0700 &#43;07.">
    Mar 25, 2019
  </span><span class="post-reading-time">
    15 min read
  </span><span class="post-taxonomies"><a href="/tags/machine-learning/" class="badge post-taxonomy">Machine learning</a><a href="/tags/deep-learning/" class="badge post-taxonomy">Deep learning</a><a href="/tags/mask-r-cnn/" class="badge post-taxonomy">Mask R-CNN</a><a href="/tags/balloon/" class="badge post-taxonomy">balloon</a><a href="/tags/b%C3%B3ng-bay/" class="badge post-taxonomy">bóng bay</a></span>
</div>
<div class="post-content mb-3"><div class="toc">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#bắt-đầu">Bắt đầu</a></li>
    <li><a href="#visualize-dữ-liệu">Visualize dữ liệu</a></li>
    <li><a href="#bounding-boxes">Bounding Boxes</a></li>
    <li><a href="#resize-images">Resize Images</a></li>
    <li><a href="#mini-masks">Mini Masks</a></li>
    <li><a href="#anchors">Anchors</a></li>
    <li><a href="#prediction">Prediction</a></li>
  </ul>
</nav>
  </div>
<h1 id="bắt-đầu">Bắt đầu<a class="anchor ms-1" href="#bắt-đầu"><i class="fas fa-link"></i></a></h1>
<p>Đầu tiên, chúng ta sẽ download tập dataset balloon tại <a href="https://github.com/matterport/Mask_RCNN/releases/download/v2.1/balloon_dataset.zip" target="_blank" rel="noopener noreferrer">https://github.com/matterport/Mask_RCNN/releases/download/v2.1/balloon_dataset.zip</a>, giải nén và bỏ trong thư mục datasets. Tiếp đó, các bạn donwload file balloon.py và visualize.py về. File đầu tiên hỗ trợ chúng ta đọc dữ liệu của dataset balloon và file thứ hai hỗ trợ visualize hình ảnh một cách trực quan. Cả hai file mình đều lấy mã nguồn của Matterport trên <a href="https://github.com/matterport/Mask_RCNN/" target="_blank" rel="noopener noreferrer">https://github.com/matterport/Mask_RCNN/</a> Tiến hành import các thư viện cần thiết về.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="kn">import</span> <span class="nn">os</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="kn">import</span> <span class="nn">sys</span>
</span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="kn">import</span> <span class="nn">itertools</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="kn">import</span> <span class="nn">math</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="kn">import</span> <span class="nn">logging</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="kn">import</span> <span class="nn">json</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="kn">import</span> <span class="nn">re</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="kn">import</span> <span class="nn">random</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="kn">import</span> <span class="nn">matplotlib</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="kn">import</span> <span class="nn">matplotlib.patches</span> <span class="k">as</span> <span class="nn">patches</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="kn">import</span> <span class="nn">matplotlib.lines</span> <span class="k">as</span> <span class="nn">lines</span>
</span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="kn">from</span> <span class="nn">matplotlib.patches</span> <span class="kn">import</span> <span class="n">Polygon</span>
</span></span><span class="line"><span class="ln">16</span><span class="cl">
</span></span><span class="line"><span class="ln">17</span><span class="cl">
</span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="kn">import</span> <span class="nn">balloon</span>
</span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="kn">import</span> <span class="nn">utils</span>
</span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="kn">import</span> <span class="nn">visualize</span>
</span></span><span class="line"><span class="ln">21</span><span class="cl">
</span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="n">config</span> <span class="o">=</span> <span class="n">balloon</span><span class="o">.</span><span class="n">BalloonConfig</span><span class="p">()</span>
</span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="n">BALLOON_DIR</span> <span class="o">=</span> <span class="s2">&#34;datasets/balloon&#34;</span>
</span></span></code></pre></div><p>Thông tin của tập train bao gồm</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="n">dataset</span> <span class="o">=</span> <span class="n">balloon</span><span class="o">.</span><span class="n">BalloonDataset</span><span class="p">()</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="n">dataset</span><span class="o">.</span><span class="n">load_balloon</span><span class="p">(</span><span class="n">BALLOON_DIR</span><span class="p">,</span> <span class="s2">&#34;train&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">
</span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="c1"># Must call before using the dataset</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="n">dataset</span><span class="o">.</span><span class="n">prepare</span><span class="p">()</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">
</span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Image Count: </span><span class="si">{}</span><span class="s2">&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">image_ids</span><span class="p">)))</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Class Count: </span><span class="si">{}</span><span class="s2">&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">num_classes</span><span class="p">))</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">info</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">class_info</span><span class="p">):</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">{:3}</span><span class="s2">. </span><span class="si">{:50}</span><span class="s2">&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]))</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="ln">1</span><span class="cl"><span class="n">Image</span> <span class="n">Count</span><span class="p">:</span> <span class="mi">61</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="n">Class</span> <span class="n">Count</span><span class="p">:</span> <span class="mi">2</span>
</span></span><span class="line"><span class="ln">3</span><span class="cl">  <span class="mf">0.</span> <span class="n">BG</span>
</span></span><span class="line"><span class="ln">4</span><span class="cl">  <span class="mf">1.</span> <span class="n">balloon</span>
</span></span></code></pre></div><p>Vậy là có tổng cộng 61 hình train. Dữ liệu được đánh làm 2 nhãn, một nhãn là background, một nhãn là balloon.</p>
<h1 id="visualize-dữ-liệu">Visualize dữ liệu<a class="anchor ms-1" href="#visualize-dữ-liệu"><i class="fas fa-link"></i></a></h1>
<p>Chúng ta sẽ load một vài hình lên xem người ta đã mask dữ liệu như thế nào. Ở đây, với mỗi hình ảnh, mình sẽ load 1 hình gốc và 4 hình của 4 quả bóng tương ứng trong hình, nếu trong hình có nhiều hơn 4 quả bóng thì chỉ vẽ 4 quả bóng đầu tiên</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="ln"> 1</span><span class="cl">
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">
</span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="n">n_col</span> <span class="o">=</span> <span class="mi">5</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">
</span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="c1"># Load and display random samples</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="n">n_col</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">9.3</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span><span class="n">subplot_kw</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;xticks&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;yticks&#39;</span><span class="p">:</span> <span class="p">[]})</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="mf">0.03</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="mf">0.97</span><span class="p">,</span> <span class="n">hspace</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="n">image_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">image_ids</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="c1"># for image_id in image_ids:</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="c1"># for ax, image_id in zip(axs.flat, image_ids):</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl">
</span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">):</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl">    <span class="n">image_id</span> <span class="o">=</span> <span class="n">image_ids</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl">
</span></span><span class="line"><span class="ln">15</span><span class="cl">    <span class="n">image</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">load_image</span><span class="p">(</span><span class="n">image_id</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">16</span><span class="cl">    <span class="n">mask</span><span class="p">,</span> <span class="n">class_ids</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">load_mask</span><span class="p">(</span><span class="n">image_id</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">17</span><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">18</span><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">class_ids</span><span class="p">))</span>
</span></span><span class="line"><span class="ln">19</span><span class="cl">
</span></span><span class="line"><span class="ln">20</span><span class="cl">    <span class="n">axs</span><span class="o">.</span><span class="n">flat</span><span class="p">[</span><span class="n">index</span><span class="o">*</span><span class="n">n_col</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">21</span><span class="cl">    <span class="n">axs</span><span class="o">.</span><span class="n">flat</span><span class="p">[</span><span class="n">index</span><span class="o">*</span><span class="n">n_col</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;img&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">22</span><span class="cl">
</span></span><span class="line"><span class="ln">23</span><span class="cl">    <span class="k">for</span> <span class="n">sub_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">class_ids</span><span class="p">)):</span>
</span></span><span class="line"><span class="ln">24</span><span class="cl">        <span class="k">if</span> <span class="n">sub_index</span> <span class="o">&gt;=</span> <span class="n">n_col</span><span class="p">:</span>
</span></span><span class="line"><span class="ln">25</span><span class="cl">            <span class="k">break</span>
</span></span><span class="line"><span class="ln">26</span><span class="cl">        <span class="n">axs</span><span class="o">.</span><span class="n">flat</span><span class="p">[</span><span class="n">index</span><span class="o">*</span><span class="n">n_col</span> <span class="o">+</span><span class="mi">1</span> <span class="o">+</span> <span class="n">sub_index</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">mask</span><span class="p">[:,:,</span><span class="n">sub_index</span><span class="p">])</span>
</span></span><span class="line"><span class="ln">27</span><span class="cl">        <span class="n">axs</span><span class="o">.</span><span class="n">flat</span><span class="p">[</span><span class="n">index</span><span class="o">*</span><span class="n">n_col</span> <span class="o">+</span> <span class="mi">1</span><span class="o">+</span><span class="n">sub_index</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">class_names</span><span class="p">[</span><span class="n">class_ids</span><span class="p">[</span><span class="n">sub_index</span><span class="p">]]))</span>
</span></span><span class="line"><span class="ln">28</span><span class="cl">
</span></span><span class="line"><span class="ln">29</span><span class="cl">
</span></span><span class="line"><span class="ln">30</span><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span></span><span class="line"><span class="ln">31</span><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span></code></pre></div><p><img class="img-fluid" alt="Hình ảnh" src="/blog/2019-03-25-mask-rcnn-balloon/mask-rnn-1.png" loading="lazy"  title="Hình ảnh"
  
   />

</p>
<p>Các bạn có thể sử dụng hàm display_top_masks của tác giả Mask R-CNN để xem thử, hàm của họ hơi khác của mình một chút.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="ln">1</span><span class="cl">
</span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="n">image_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">image_ids</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="k">for</span> <span class="n">image_id</span> <span class="ow">in</span> <span class="n">image_ids</span><span class="p">:</span>
</span></span><span class="line"><span class="ln">4</span><span class="cl">    <span class="n">image</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">load_image</span><span class="p">(</span><span class="n">image_id</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">5</span><span class="cl">    <span class="n">mask</span><span class="p">,</span> <span class="n">class_ids</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">load_mask</span><span class="p">(</span><span class="n">image_id</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">6</span><span class="cl">    <span class="n">visualize</span><span class="o">.</span><span class="n">display_top_masks</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">class_ids</span><span class="p">,</span> <span class="n">dataset</span><span class="o">.</span><span class="n">class_names</span><span class="p">)</span>
</span></span></code></pre></div><p><img class="img-fluid" alt="Hình ảnh" src="/blog/2019-03-25-mask-rcnn-balloon/f-rcnn-image2.jpg" loading="lazy"  title="Hình ảnh"
  
   />

</p>
<h1 id="bounding-boxes">Bounding Boxes<a class="anchor ms-1" href="#bounding-boxes"><i class="fas fa-link"></i></a></h1>
<p>Chúng ta có 2 cách để lấy Bounding Boxes của các hình. Một là lấy trực tiếp từ tập dataset (đối với những dataset có lưu bounding box), hai là rút trích bounding box từ các toạ độ mask. Chúng ta nên thực hiện cách hai, lý do là chúng ta sẽ dùng các kỹ thuật Data Generator để sinh nhiều ảnh hơn cung cấp cho thuật toán train. Lúc này, việc tính lại bounding box sẽ dễ dàng hơn.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="ln"> 1</span><span class="cl">
</span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="c1"># Load random image and mask.</span>
</span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="n">image_id</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">image_ids</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="n">image</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">load_image</span><span class="p">(</span><span class="n">image_id</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="n">mask</span><span class="p">,</span> <span class="n">class_ids</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">load_mask</span><span class="p">(</span><span class="n">image_id</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">
</span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="c1"># Compute Bounding box</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="n">bbox</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">extract_bboxes</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">
</span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="c1"># Display image and additional stats</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;image_id &#34;</span><span class="p">,</span> <span class="n">image_id</span><span class="p">,</span> <span class="n">dataset</span><span class="o">.</span><span class="n">image_reference</span><span class="p">(</span><span class="n">image_id</span><span class="p">))</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl">
</span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="c1"># Display image and instances</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="n">visualize</span><span class="o">.</span><span class="n">display_instances</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">bbox</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">class_ids</span><span class="p">,</span> <span class="n">dataset</span><span class="o">.</span><span class="n">class_names</span><span class="p">)</span>
</span></span></code></pre></div><p><img class="img-fluid" alt="Hình ảnh" src="/blog/2019-03-25-mask-rcnn-balloon/mask-rcnn-3.jpg" loading="lazy"  title="Hình ảnh"
  
   />

</p>
<h1 id="resize-images">Resize Images<a class="anchor ms-1" href="#resize-images"><i class="fas fa-link"></i></a></h1>
<p>Các ảnh trong tập train có các kích thước khác nhau. Các bạn có thể xem các hình ở trên, có ảnh có kích thước này, có ảnh có kích thước kia. Chúng ta sẽ resize chúng về cùng một kích thước (ví dụ 1024x1024) để làm đầu vào cho tập huấn luyện. Và chúng ta sẽ sử dụng zero padding để lấp đầy những khoảng trống của những ảnh không đủ kích thước.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="ln"> 1</span><span class="cl">
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">
</span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="c1"># Load random image and mask.</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="n">image_id</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">image_ids</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="n">image</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">load_image</span><span class="p">(</span><span class="n">image_id</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="n">mask</span><span class="p">,</span> <span class="n">class_ids</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">load_mask</span><span class="p">(</span><span class="n">image_id</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="n">original_shape</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="c1"># Resize</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="n">image</span><span class="p">,</span> <span class="n">window</span><span class="p">,</span> <span class="n">scale</span><span class="p">,</span> <span class="n">padding</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">resize_image</span><span class="p">(</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl">    <span class="n">image</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl">    <span class="n">min_dim</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">IMAGE_MIN_DIM</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl">    <span class="n">max_dim</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">IMAGE_MAX_DIM</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl">    <span class="n">mode</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">IMAGE_RESIZE_MODE</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="n">mask</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">resize_mask</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">scale</span><span class="p">,</span> <span class="n">padding</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="c1"># Compute Bounding box</span>
</span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="n">bbox</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">extract_bboxes</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">18</span><span class="cl">
</span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="c1"># Display image and additional stats</span>
</span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;image_id: &#34;</span><span class="p">,</span> <span class="n">image_id</span><span class="p">,</span> <span class="n">dataset</span><span class="o">.</span><span class="n">image_reference</span><span class="p">(</span><span class="n">image_id</span><span class="p">))</span>
</span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Original shape: &#34;</span><span class="p">,</span> <span class="n">original_shape</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Resize shape: &#34;</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="c1"># Display image and instances</span>
</span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="n">visualize</span><span class="o">.</span><span class="n">display_instances</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">bbox</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">class_ids</span><span class="p">,</span> <span class="n">dataset</span><span class="o">.</span><span class="n">class_names</span><span class="p">)</span>
</span></span></code></pre></div><p>Kết quả</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="ln">1</span><span class="cl"><span class="n">image_id</span><span class="p">:</span>  <span class="mi">9</span> <span class="n">datasets</span><span class="o">/</span><span class="n">balloon</span>\<span class="n">train</span>\<span class="mi">15290896925_884</span><span class="n">ab33fd3_k</span><span class="o">.</span><span class="n">jpg</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="n">Original</span> <span class="n">shape</span><span class="p">:</span>  <span class="p">(</span><span class="mi">1356</span><span class="p">,</span> <span class="mi">2048</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="n">Resize</span> <span class="n">shape</span><span class="p">:</span>  <span class="p">(</span><span class="mi">1024</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
</span></span></code></pre></div><p><img class="img-fluid" alt="Hình ảnh" src="/blog/2019-03-25-mask-rcnn-balloon/f-rcnn-image4.jpg" loading="lazy"  title="Hình ảnh"
  
   />

</p>
<p>Lưu ý một điều là ở đây, mình sử dụng random image, nên nếu các bạn chạy lại câu lệnh như mình thì kết quả ra phần nhiều sẽ khác mình. Tuy nhiên, Resize shape luôn là (1024, 1024, 3).</p>
<h1 id="mini-masks">Mini Masks<a class="anchor ms-1" href="#mini-masks"><i class="fas fa-link"></i></a></h1>
<p>Một vấn đề khá nghiêm trọng ở đây là chúng ta cần khá nhiều bộ nhớ để lưu các masks. Numpy sử dụng 1 byte để lưu 1 giá trị bit. Do đó, với kích thước ảnh là 1024x1024, chúng ta cần 1MB bộ nhớ ram để lưu trữ. Nếu chúng ta có tập dataset tầm 1000 bức ảnh thì cần đến 1GB bộ nhớ, khá là lớn. Ngoài việc tốn bộ nhớ lữu trữ, chúng còn làm chậm tốc độ huấn luyện mô hình nữa.</p>
<p>Để cải tiến, chúng ta có thể sử dụng một trong hai cách sau:</p>
<ul>
<li>Cách thứ nhất: Thay vì lưu toàn bộ mask của toàn bức ảnh, chúng ta chỉ lưu những pixel của mask trong bounding box. Với việc sử dụng cách này, chúng ta sẽ tiết kiệm kha khá bộ nhớ chính.</li>
<li>Cách thứ hai: Chúng ta có thể resize mask về một kích thước chuẩn nào đó, ví dụ 48x48 pixel. Với những mask có kích thước lớn hơn 48x48, chúng sẽ bị mất thông tin.</li>
</ul>
<p>Mình không thích cách thứ hai cho lắm. Tuy nhiên, theo lý giải của nhóm tác giả Mask R-CNN, thì hầu hết việc gán các đường biên (object annotations) thường không chính xác cho lắm (thừa hoặc thiếu một vài chỗ), cho nên, việc mất mát thông tin với lượng nhỏ này hầu như là không đáng kể.</p>
<p>Để đánh giá hiệu quả của hàm mask resizing, chúng ta sẽ chạy đoạn code bên dưới và xem ảnh kết quả. Đoạn code trên mình sử dụng 2 hàm compose_image_meta và load_image_gt của tác giả ở đường dẫn <a href="https://github.com/matterport/Mask_RCNN/blob/master/mrcnn/model.py" target="_blank" rel="noopener noreferrer">https://github.com/matterport/Mask_RCNN/blob/master/mrcnn/model.py</a>. Mình có modify lại hàm load_image_gt một chút để hợp với ý mình hơn.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="ln">  1</span><span class="cl"><span class="c1">##############################</span>
</span></span><span class="line"><span class="ln">  2</span><span class="cl"><span class="c1">#  Data Formatting</span>
</span></span><span class="line"><span class="ln">  3</span><span class="cl"><span class="c1">##############################</span>
</span></span><span class="line"><span class="ln">  4</span><span class="cl">
</span></span><span class="line"><span class="ln">  5</span><span class="cl"><span class="k">def</span> <span class="nf">compose_image_meta</span><span class="p">(</span><span class="n">image_id</span><span class="p">,</span> <span class="n">original_image_shape</span><span class="p">,</span> <span class="n">image_shape</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">  6</span><span class="cl">                       <span class="n">window</span><span class="p">,</span> <span class="n">scale</span><span class="p">,</span> <span class="n">active_class_ids</span><span class="p">):</span>
</span></span><span class="line"><span class="ln">  7</span><span class="cl">    <span class="s2">&#34;&#34;&#34;Takes attributes of an image and puts them in one 1D array.
</span></span></span><span class="line"><span class="ln">  8</span><span class="cl"><span class="s2">    image_id: An int ID of the image. Useful for debugging.
</span></span></span><span class="line"><span class="ln">  9</span><span class="cl"><span class="s2">    original_image_shape: [H, W, C] before resizing or padding.
</span></span></span><span class="line"><span class="ln"> 10</span><span class="cl"><span class="s2">    image_shape: [H, W, C] after resizing and padding
</span></span></span><span class="line"><span class="ln"> 11</span><span class="cl"><span class="s2">    window: (y1, x1, y2, x2) in pixels. The area of the image where the real
</span></span></span><span class="line"><span class="ln"> 12</span><span class="cl"><span class="s2">            image is (excluding the padding)
</span></span></span><span class="line"><span class="ln"> 13</span><span class="cl"><span class="s2">    scale: The scaling factor applied to the original image (float32)
</span></span></span><span class="line"><span class="ln"> 14</span><span class="cl"><span class="s2">    active_class_ids: List of class_ids available in the dataset from which
</span></span></span><span class="line"><span class="ln"> 15</span><span class="cl"><span class="s2">        the image came. Useful if training on images from multiple datasets
</span></span></span><span class="line"><span class="ln"> 16</span><span class="cl"><span class="s2">        where not all classes are present in all datasets.
</span></span></span><span class="line"><span class="ln"> 17</span><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="ln"> 18</span><span class="cl">    <span class="n">meta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
</span></span><span class="line"><span class="ln"> 19</span><span class="cl">        <span class="p">[</span><span class="n">image_id</span><span class="p">]</span> <span class="o">+</span>                  <span class="c1"># size=1</span>
</span></span><span class="line"><span class="ln"> 20</span><span class="cl">        <span class="nb">list</span><span class="p">(</span><span class="n">original_image_shape</span><span class="p">)</span> <span class="o">+</span>  <span class="c1"># size=3</span>
</span></span><span class="line"><span class="ln"> 21</span><span class="cl">        <span class="nb">list</span><span class="p">(</span><span class="n">image_shape</span><span class="p">)</span> <span class="o">+</span>           <span class="c1"># size=3</span>
</span></span><span class="line"><span class="ln"> 22</span><span class="cl">        <span class="nb">list</span><span class="p">(</span><span class="n">window</span><span class="p">)</span> <span class="o">+</span>                <span class="c1"># size=4 (y1, x1, y2, x2) in image cooredinates</span>
</span></span><span class="line"><span class="ln"> 23</span><span class="cl">        <span class="p">[</span><span class="n">scale</span><span class="p">]</span> <span class="o">+</span>                     <span class="c1"># size=1</span>
</span></span><span class="line"><span class="ln"> 24</span><span class="cl">        <span class="nb">list</span><span class="p">(</span><span class="n">active_class_ids</span><span class="p">)</span>        <span class="c1"># size=num_classes</span>
</span></span><span class="line"><span class="ln"> 25</span><span class="cl">    <span class="p">)</span>
</span></span><span class="line"><span class="ln"> 26</span><span class="cl">    <span class="k">return</span> <span class="n">meta</span>
</span></span><span class="line"><span class="ln"> 27</span><span class="cl">
</span></span><span class="line"><span class="ln"> 28</span><span class="cl">
</span></span><span class="line"><span class="ln"> 29</span><span class="cl"><span class="k">def</span> <span class="nf">load_image_gt</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">image_id</span><span class="p">,</span> <span class="n">augment</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">augmentation</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span></span><span class="line"><span class="ln"> 30</span><span class="cl">                  <span class="n">use_mini_mask</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span></span><span class="line"><span class="ln"> 31</span><span class="cl">    <span class="s2">&#34;&#34;&#34;Load and return ground truth data for an image (image, mask, bounding boxes).
</span></span></span><span class="line"><span class="ln"> 32</span><span class="cl"><span class="s2">    augment: (deprecated. Use augmentation instead). If true, apply random
</span></span></span><span class="line"><span class="ln"> 33</span><span class="cl"><span class="s2">        image augmentation. Currently, only horizontal flipping is offered.
</span></span></span><span class="line"><span class="ln"> 34</span><span class="cl"><span class="s2">    augmentation: Optional. An imgaug (https://github.com/aleju/imgaug) augmentation.
</span></span></span><span class="line"><span class="ln"> 35</span><span class="cl"><span class="s2">        For example, passing imgaug.augmenters.Fliplr(0.5) flips images
</span></span></span><span class="line"><span class="ln"> 36</span><span class="cl"><span class="s2">        right/left 50</span><span class="si">% o</span><span class="s2">f the time.
</span></span></span><span class="line"><span class="ln"> 37</span><span class="cl"><span class="s2">    use_mini_mask: If False, returns full-size masks that are the same height
</span></span></span><span class="line"><span class="ln"> 38</span><span class="cl"><span class="s2">        and width as the original image. These can be big, for example
</span></span></span><span class="line"><span class="ln"> 39</span><span class="cl"><span class="s2">        1024x1024x100 (for 100 instances). Mini masks are smaller, typically,
</span></span></span><span class="line"><span class="ln"> 40</span><span class="cl"><span class="s2">        224x224 and are generated by extracting the bounding box of the
</span></span></span><span class="line"><span class="ln"> 41</span><span class="cl"><span class="s2">        object and resizing it to MINI_MASK_SHAPE.
</span></span></span><span class="line"><span class="ln"> 42</span><span class="cl"><span class="s2">    Returns:
</span></span></span><span class="line"><span class="ln"> 43</span><span class="cl"><span class="s2">    image: [height, width, 3]
</span></span></span><span class="line"><span class="ln"> 44</span><span class="cl"><span class="s2">    shape: the original shape of the image before resizing and cropping.
</span></span></span><span class="line"><span class="ln"> 45</span><span class="cl"><span class="s2">    class_ids: [instance_count] Integer class IDs
</span></span></span><span class="line"><span class="ln"> 46</span><span class="cl"><span class="s2">    bbox: [instance_count, (y1, x1, y2, x2)]
</span></span></span><span class="line"><span class="ln"> 47</span><span class="cl"><span class="s2">    mask: [height, width, instance_count]. The height and width are those
</span></span></span><span class="line"><span class="ln"> 48</span><span class="cl"><span class="s2">        of the image unless use_mini_mask is True, in which case they are
</span></span></span><span class="line"><span class="ln"> 49</span><span class="cl"><span class="s2">        defined in MINI_MASK_SHAPE.
</span></span></span><span class="line"><span class="ln"> 50</span><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="ln"> 51</span><span class="cl">    <span class="c1"># Load image and mask</span>
</span></span><span class="line"><span class="ln"> 52</span><span class="cl">    <span class="n">image</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">load_image</span><span class="p">(</span><span class="n">image_id</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 53</span><span class="cl">    <span class="n">mask</span><span class="p">,</span> <span class="n">class_ids</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">load_mask</span><span class="p">(</span><span class="n">image_id</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 54</span><span class="cl">    <span class="n">original_shape</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span>
</span></span><span class="line"><span class="ln"> 55</span><span class="cl">    <span class="n">image</span><span class="p">,</span> <span class="n">window</span><span class="p">,</span> <span class="n">scale</span><span class="p">,</span> <span class="n">padding</span><span class="p">,</span> <span class="n">crop</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">resize_image</span><span class="p">(</span>
</span></span><span class="line"><span class="ln"> 56</span><span class="cl">        <span class="n">image</span><span class="p">,</span>
</span></span><span class="line"><span class="ln"> 57</span><span class="cl">        <span class="n">min_dim</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">IMAGE_MIN_DIM</span><span class="p">,</span>
</span></span><span class="line"><span class="ln"> 58</span><span class="cl">        <span class="n">min_scale</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">IMAGE_MIN_SCALE</span><span class="p">,</span>
</span></span><span class="line"><span class="ln"> 59</span><span class="cl">        <span class="n">max_dim</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">IMAGE_MAX_DIM</span><span class="p">,</span>
</span></span><span class="line"><span class="ln"> 60</span><span class="cl">        <span class="n">mode</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">IMAGE_RESIZE_MODE</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 61</span><span class="cl">    <span class="n">mask</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">resize_mask</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">scale</span><span class="p">,</span> <span class="n">padding</span><span class="p">,</span> <span class="n">crop</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 62</span><span class="cl">
</span></span><span class="line"><span class="ln"> 63</span><span class="cl">    <span class="c1"># Random horizontal flips.</span>
</span></span><span class="line"><span class="ln"> 64</span><span class="cl">    <span class="c1"># TODO: will be removed in a future update in favor of augmentation</span>
</span></span><span class="line"><span class="ln"> 65</span><span class="cl">    <span class="k">if</span> <span class="n">augment</span><span class="p">:</span>
</span></span><span class="line"><span class="ln"> 66</span><span class="cl">        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&#34;&#39;augment&#39; is deprecated. Use &#39;augmentation&#39; instead.&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 67</span><span class="cl">        <span class="k">if</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
</span></span><span class="line"><span class="ln"> 68</span><span class="cl">            <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fliplr</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 69</span><span class="cl">            <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fliplr</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 70</span><span class="cl">
</span></span><span class="line"><span class="ln"> 71</span><span class="cl">    <span class="c1"># Augmentation</span>
</span></span><span class="line"><span class="ln"> 72</span><span class="cl">    <span class="c1"># This requires the imgaug lib (https://github.com/aleju/imgaug)</span>
</span></span><span class="line"><span class="ln"> 73</span><span class="cl">    <span class="k">if</span> <span class="n">augmentation</span><span class="p">:</span>
</span></span><span class="line"><span class="ln"> 74</span><span class="cl">        <span class="kn">import</span> <span class="nn">imgaug</span>
</span></span><span class="line"><span class="ln"> 75</span><span class="cl">
</span></span><span class="line"><span class="ln"> 76</span><span class="cl">        <span class="c1"># Augmenters that are safe to apply to masks</span>
</span></span><span class="line"><span class="ln"> 77</span><span class="cl">        <span class="c1"># Some, such as Affine, have settings that make them unsafe, so always</span>
</span></span><span class="line"><span class="ln"> 78</span><span class="cl">        <span class="c1"># test your augmentation on masks</span>
</span></span><span class="line"><span class="ln"> 79</span><span class="cl">        <span class="n">MASK_AUGMENTERS</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;Sequential&#34;</span><span class="p">,</span> <span class="s2">&#34;SomeOf&#34;</span><span class="p">,</span> <span class="s2">&#34;OneOf&#34;</span><span class="p">,</span> <span class="s2">&#34;Sometimes&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln"> 80</span><span class="cl">                           <span class="s2">&#34;Fliplr&#34;</span><span class="p">,</span> <span class="s2">&#34;Flipud&#34;</span><span class="p">,</span> <span class="s2">&#34;CropAndPad&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln"> 81</span><span class="cl">                           <span class="s2">&#34;Affine&#34;</span><span class="p">,</span> <span class="s2">&#34;PiecewiseAffine&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="ln"> 82</span><span class="cl">
</span></span><span class="line"><span class="ln"> 83</span><span class="cl">        <span class="k">def</span> <span class="nf">hook</span><span class="p">(</span><span class="n">images</span><span class="p">,</span> <span class="n">augmenter</span><span class="p">,</span> <span class="n">parents</span><span class="p">,</span> <span class="n">default</span><span class="p">):</span>
</span></span><span class="line"><span class="ln"> 84</span><span class="cl">            <span class="s2">&#34;&#34;&#34;Determines which augmenters to apply to masks.&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="ln"> 85</span><span class="cl">            <span class="k">return</span> <span class="n">augmenter</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="ow">in</span> <span class="n">MASK_AUGMENTERS</span>
</span></span><span class="line"><span class="ln"> 86</span><span class="cl">
</span></span><span class="line"><span class="ln"> 87</span><span class="cl">        <span class="c1"># Store shapes before augmentation to compare</span>
</span></span><span class="line"><span class="ln"> 88</span><span class="cl">        <span class="n">image_shape</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span>
</span></span><span class="line"><span class="ln"> 89</span><span class="cl">        <span class="n">mask_shape</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">shape</span>
</span></span><span class="line"><span class="ln"> 90</span><span class="cl">        <span class="c1"># Make augmenters deterministic to apply similarly to images and masks</span>
</span></span><span class="line"><span class="ln"> 91</span><span class="cl">        <span class="n">det</span> <span class="o">=</span> <span class="n">augmentation</span><span class="o">.</span><span class="n">to_deterministic</span><span class="p">()</span>
</span></span><span class="line"><span class="ln"> 92</span><span class="cl">        <span class="n">image</span> <span class="o">=</span> <span class="n">det</span><span class="o">.</span><span class="n">augment_image</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 93</span><span class="cl">        <span class="c1"># Change mask to np.uint8 because imgaug doesn&#39;t support np.bool</span>
</span></span><span class="line"><span class="ln"> 94</span><span class="cl">        <span class="n">mask</span> <span class="o">=</span> <span class="n">det</span><span class="o">.</span><span class="n">augment_image</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">),</span>
</span></span><span class="line"><span class="ln"> 95</span><span class="cl">                                 <span class="n">hooks</span><span class="o">=</span><span class="n">imgaug</span><span class="o">.</span><span class="n">HooksImages</span><span class="p">(</span><span class="n">activator</span><span class="o">=</span><span class="n">hook</span><span class="p">))</span>
</span></span><span class="line"><span class="ln"> 96</span><span class="cl">        <span class="c1"># Verify that shapes didn&#39;t change</span>
</span></span><span class="line"><span class="ln"> 97</span><span class="cl">        <span class="k">assert</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">image_shape</span><span class="p">,</span> <span class="s2">&#34;Augmentation shouldn&#39;t change image size&#34;</span>
</span></span><span class="line"><span class="ln"> 98</span><span class="cl">        <span class="k">assert</span> <span class="n">mask</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">mask_shape</span><span class="p">,</span> <span class="s2">&#34;Augmentation shouldn&#39;t change mask size&#34;</span>
</span></span><span class="line"><span class="ln"> 99</span><span class="cl">        <span class="c1"># Change mask back to bool</span>
</span></span><span class="line"><span class="ln">100</span><span class="cl">        <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">bool</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">101</span><span class="cl">
</span></span><span class="line"><span class="ln">102</span><span class="cl">    <span class="c1"># Note that some boxes might be all zeros if the corresponding mask got cropped out.</span>
</span></span><span class="line"><span class="ln">103</span><span class="cl">    <span class="c1"># and here is to filter them out</span>
</span></span><span class="line"><span class="ln">104</span><span class="cl">    <span class="n">_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span>
</span></span><span class="line"><span class="ln">105</span><span class="cl">    <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">_idx</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">106</span><span class="cl">    <span class="n">class_ids</span> <span class="o">=</span> <span class="n">class_ids</span><span class="p">[</span><span class="n">_idx</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">107</span><span class="cl">    <span class="c1"># Bounding boxes. Note that some boxes might be all zeros</span>
</span></span><span class="line"><span class="ln">108</span><span class="cl">    <span class="c1"># if the corresponding mask got cropped out.</span>
</span></span><span class="line"><span class="ln">109</span><span class="cl">    <span class="c1"># bbox: [num_instances, (y1, x1, y2, x2)]</span>
</span></span><span class="line"><span class="ln">110</span><span class="cl">    <span class="n">bbox</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">extract_bboxes</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">111</span><span class="cl">
</span></span><span class="line"><span class="ln">112</span><span class="cl">    <span class="c1"># Active classes</span>
</span></span><span class="line"><span class="ln">113</span><span class="cl">    <span class="c1"># Different datasets have different classes, so track the</span>
</span></span><span class="line"><span class="ln">114</span><span class="cl">    <span class="c1"># classes supported in the dataset of this image.</span>
</span></span><span class="line"><span class="ln">115</span><span class="cl">    <span class="n">active_class_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">dataset</span><span class="o">.</span><span class="n">num_classes</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">116</span><span class="cl">    <span class="n">source_class_ids</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">source_class_ids</span><span class="p">[</span><span class="n">dataset</span><span class="o">.</span><span class="n">image_info</span><span class="p">[</span><span class="n">image_id</span><span class="p">][</span><span class="s2">&#34;source&#34;</span><span class="p">]]</span>
</span></span><span class="line"><span class="ln">117</span><span class="cl">    <span class="n">active_class_ids</span><span class="p">[</span><span class="n">source_class_ids</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="ln">118</span><span class="cl">
</span></span><span class="line"><span class="ln">119</span><span class="cl">    <span class="c1"># Resize masks to smaller size to reduce memory usage</span>
</span></span><span class="line"><span class="ln">120</span><span class="cl">    <span class="k">if</span> <span class="n">use_mini_mask</span><span class="p">:</span>
</span></span><span class="line"><span class="ln">121</span><span class="cl">        <span class="k">if</span> <span class="n">USE_MINI_MASK_SHAPE</span><span class="p">:</span>
</span></span><span class="line"><span class="ln">122</span><span class="cl">            <span class="n">mask</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">minimize_mask</span><span class="p">(</span><span class="n">bbox</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">MINI_MASK_SHAPE</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">123</span><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="ln">124</span><span class="cl">            <span class="n">mask</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">minimize_mask</span><span class="p">(</span><span class="n">bbox</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">mask</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">])</span>
</span></span><span class="line"><span class="ln">125</span><span class="cl">
</span></span><span class="line"><span class="ln">126</span><span class="cl">    <span class="c1"># Image meta data</span>
</span></span><span class="line"><span class="ln">127</span><span class="cl">    <span class="n">image_meta</span> <span class="o">=</span> <span class="n">compose_image_meta</span><span class="p">(</span><span class="n">image_id</span><span class="p">,</span> <span class="n">original_shape</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">128</span><span class="cl">                                    <span class="n">window</span><span class="p">,</span> <span class="n">scale</span><span class="p">,</span> <span class="n">active_class_ids</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">129</span><span class="cl">
</span></span><span class="line"><span class="ln">130</span><span class="cl">    <span class="k">return</span> <span class="n">image</span><span class="p">,</span> <span class="n">image_meta</span><span class="p">,</span> <span class="n">class_ids</span><span class="p">,</span> <span class="n">bbox</span><span class="p">,</span> <span class="n">mask</span>
</span></span><span class="line"><span class="ln">131</span><span class="cl">
</span></span><span class="line"><span class="ln">132</span><span class="cl">
</span></span><span class="line"><span class="ln">133</span><span class="cl"><span class="n">image_id</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">image_ids</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">134</span><span class="cl"><span class="n">image</span><span class="p">,</span> <span class="n">image_meta</span><span class="p">,</span> <span class="n">class_ids</span><span class="p">,</span> <span class="n">bbox</span><span class="p">,</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">load_image_gt</span><span class="p">(</span>
</span></span><span class="line"><span class="ln">135</span><span class="cl">    <span class="n">dataset</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">image_id</span><span class="p">,</span> <span class="n">use_mini_mask</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">136</span><span class="cl">
</span></span><span class="line"><span class="ln">137</span><span class="cl">
</span></span><span class="line"><span class="ln">138</span><span class="cl"><span class="n">visualize</span><span class="o">.</span><span class="n">display_images</span><span class="p">([</span><span class="n">image</span><span class="p">]</span><span class="o">+</span><span class="p">[</span><span class="n">mask</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="mi">5</span><span class="p">))])</span>
</span></span><span class="line"><span class="ln">139</span><span class="cl">
</span></span><span class="line"><span class="ln">140</span><span class="cl"><span class="n">image</span><span class="p">,</span> <span class="n">image_meta</span><span class="p">,</span> <span class="n">class_ids</span><span class="p">,</span> <span class="n">bbox</span><span class="p">,</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">load_image_gt</span><span class="p">(</span>
</span></span><span class="line"><span class="ln">141</span><span class="cl">    <span class="n">dataset</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">image_id</span><span class="p">,</span> <span class="n">use_mini_mask</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">142</span><span class="cl">
</span></span><span class="line"><span class="ln">143</span><span class="cl">
</span></span><span class="line"><span class="ln">144</span><span class="cl"><span class="n">visualize</span><span class="o">.</span><span class="n">display_images</span><span class="p">([</span><span class="n">image</span><span class="p">]</span><span class="o">+</span><span class="p">[</span><span class="n">mask</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="mi">5</span><span class="p">))])</span>
</span></span><span class="line"><span class="ln">145</span><span class="cl">
</span></span><span class="line"><span class="ln">146</span><span class="cl"><span class="n">USE_MINI_MASK_SHAPE</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="ln">147</span><span class="cl">
</span></span><span class="line"><span class="ln">148</span><span class="cl"><span class="n">image</span><span class="p">,</span> <span class="n">image_meta</span><span class="p">,</span> <span class="n">class_ids</span><span class="p">,</span> <span class="n">bbox</span><span class="p">,</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">load_image_gt</span><span class="p">(</span>
</span></span><span class="line"><span class="ln">149</span><span class="cl">    <span class="n">dataset</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">image_id</span><span class="p">,</span> <span class="n">use_mini_mask</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">150</span><span class="cl">
</span></span><span class="line"><span class="ln">151</span><span class="cl">
</span></span><span class="line"><span class="ln">152</span><span class="cl"><span class="n">visualize</span><span class="o">.</span><span class="n">display_images</span><span class="p">([</span><span class="n">image</span><span class="p">]</span><span class="o">+</span><span class="p">[</span><span class="n">mask</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="mi">5</span><span class="p">))])</span>
</span></span><span class="line"><span class="ln">153</span><span class="cl">
</span></span><span class="line"><span class="ln">154</span><span class="cl"><span class="n">mask</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">expand_mask</span><span class="p">(</span><span class="n">bbox</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">155</span><span class="cl"><span class="n">visualize</span><span class="o">.</span><span class="n">display_instances</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">bbox</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">class_ids</span><span class="p">,</span> <span class="n">dataset</span><span class="o">.</span><span class="n">class_names</span><span class="p">)</span>
</span></span></code></pre></div><p><img class="img-fluid" alt="Hình ảnh" src="/blog/2019-03-25-mask-rcnn-balloon/f-rcnn-image6.jpg" loading="lazy"  title="Hình ảnh"
  
   />

</p>
<p>Với ảnh ở line 1 là ảnh gốc ban đầu và các full mask của bức ảnh, ảnh ở line 2 là chỉ lấy mask của bounding box, ảnh ở line 3 là lấy mask ở bounding box và scale ảnh (do scale ảnh nên ở line 3 các bạn sẽ thấy mask có hình răng cưa, khác với các mask line 2). Line 4 là ảnh ở line 3 được revert back lại hình gốc ban đầu. Các bạn có để ý thấy rằng nó sẽ bị răng cưa ở biên cạnh chứ không được smooth như ảnh gốc. Nếu chúng ta không làm object annotations kỹ, thì object cũng sẽ bị răng cưa như trên.</p>
<h1 id="anchors">Anchors<a class="anchor ms-1" href="#anchors"><i class="fas fa-link"></i></a></h1>
<p>Thứ tự của các anchor thật sự rất quan trọng. Trong quá trình train, thứ tự của các anchor như thế nào thì trong quá trình test, validation, prediction phải dùng y hệt vậy.</p>
<p>Trong mạng FPN, các anchor phải được xắp xếp theo cách mà chúng ta có thể dễ dàng liên kết với giá trị output</p>
<ul>
<li>
<p>Xắp xếp các anchor theo thứ tự các lớp của pyramid. Tất cả các anchor của level đầu tiên, tiếp theo là các anchor của các lớp thứ hai, lớp thư ba&hellip; Việc xắp xếp theo cách này sẽ giúp chúng ta dễ dàng phân tách các lớp anchor và dễ hiểu theo lẽ tự nhiên.</p>
</li>
<li>
<p>Trong mỗi level, xắp xếp các anchor trong mỗi level bằng thứ tự xử lý của các feature map. Thông thường, một convolution layer sẽ dịch chuyển trên feature map bắt đầu từ vị trí trái - trên (top - left) đi xuống phải dưới (từ trái qua phải, xuống hàng rồi lại từ trái qua phải).</p>
</li>
<li>
<p>Trên mỗi cell của feature map, chúng ta sẽ xắp xếp các anchor theo các ratios.</p>
</li>
</ul>
<p>Anchor Stride:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="ln"> 1</span><span class="cl">
</span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="n">backbone_shapes</span> <span class="o">=</span> <span class="n">modellib</span><span class="o">.</span><span class="n">compute_backbone_shapes</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">IMAGE_SHAPE</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="n">anchors</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">generate_pyramid_anchors</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">RPN_ANCHOR_SCALES</span><span class="p">,</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">                                          <span class="n">config</span><span class="o">.</span><span class="n">RPN_ANCHOR_RATIOS</span><span class="p">,</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">                                          <span class="n">backbone_shapes</span><span class="p">,</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">                                          <span class="n">config</span><span class="o">.</span><span class="n">BACKBONE_STRIDES</span><span class="p">,</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">                                          <span class="n">config</span><span class="o">.</span><span class="n">RPN_ANCHOR_STRIDE</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">
</span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="c1"># Print summary of anchors</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="n">num_levels</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">backbone_shapes</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="n">anchors_per_cell</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">RPN_ANCHOR_RATIOS</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Total anchors: &#34;</span><span class="p">,</span> <span class="n">anchors</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;ANCHOR Scales: &#34;</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">RPN_ANCHOR_SCALES</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;BACKBONE STRIDE: &#34;</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">BACKBONE_STRIDES</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;ratios: &#34;</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">RPN_ANCHOR_RATIOS</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Anchors per Cell: &#34;</span><span class="p">,</span> <span class="n">anchors_per_cell</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="c1"># print(&#34;Anchors stride: &#34;, config.RPN_ANCHOR_STRIDE)</span>
</span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Levels: &#34;</span><span class="p">,</span> <span class="n">num_levels</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="n">anchors_per_level</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_levels</span><span class="p">):</span>
</span></span><span class="line"><span class="ln">21</span><span class="cl">    <span class="n">num_cells</span> <span class="o">=</span> <span class="n">backbone_shapes</span><span class="p">[</span><span class="n">l</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">backbone_shapes</span><span class="p">[</span><span class="n">l</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">22</span><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;backbone_shapes in level &#34;</span><span class="p">,</span><span class="n">l</span><span class="p">,</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">backbone_shapes</span><span class="p">[</span><span class="n">l</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="n">backbone_shapes</span><span class="p">[</span><span class="n">l</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
</span></span><span class="line"><span class="ln">23</span><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;num_cells in level &#34;</span><span class="p">,</span><span class="n">l</span><span class="p">,</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">num_cells</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">24</span><span class="cl">    <span class="n">anchors_per_level</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">anchors_per_cell</span> <span class="o">*</span> <span class="n">num_cells</span> <span class="o">//</span> <span class="n">config</span><span class="o">.</span><span class="n">RPN_ANCHOR_STRIDE</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">25</span><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Anchors in Level </span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">anchors_per_level</span><span class="p">[</span><span class="n">l</span><span class="p">]))</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="n">Total</span> <span class="n">anchors</span><span class="p">:</span>  <span class="mi">261888</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="n">ANCHOR</span> <span class="n">Scales</span><span class="p">:</span>  <span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">512</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="n">BACKBONE</span> <span class="n">STRIDE</span><span class="p">:</span>  <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">64</span><span class="p">]</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="n">ratios</span><span class="p">:</span>  <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="n">Anchors</span> <span class="n">per</span> <span class="n">Cell</span><span class="p">:</span>  <span class="mi">3</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="n">Levels</span><span class="p">:</span>  <span class="mi">5</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="n">backbone_shapes</span> <span class="ow">in</span> <span class="n">level</span>  <span class="mi">0</span>   <span class="mi">256</span> <span class="n">x</span> <span class="mi">256</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="n">num_cells</span> <span class="ow">in</span> <span class="n">level</span>  <span class="mi">0</span>   <span class="mi">65536</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="n">Anchors</span> <span class="ow">in</span> <span class="n">Level</span> <span class="mi">0</span><span class="p">:</span> <span class="mi">196608</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="n">backbone_shapes</span> <span class="ow">in</span> <span class="n">level</span>  <span class="mi">1</span>   <span class="mi">128</span> <span class="n">x</span> <span class="mi">128</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="n">num_cells</span> <span class="ow">in</span> <span class="n">level</span>  <span class="mi">1</span>   <span class="mi">16384</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="n">Anchors</span> <span class="ow">in</span> <span class="n">Level</span> <span class="mi">1</span><span class="p">:</span> <span class="mi">49152</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="n">backbone_shapes</span> <span class="ow">in</span> <span class="n">level</span>  <span class="mi">2</span>   <span class="mi">64</span> <span class="n">x</span> <span class="mi">64</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="n">num_cells</span> <span class="ow">in</span> <span class="n">level</span>  <span class="mi">2</span>   <span class="mi">4096</span>
</span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="n">Anchors</span> <span class="ow">in</span> <span class="n">Level</span> <span class="mi">2</span><span class="p">:</span> <span class="mi">12288</span>
</span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="n">backbone_shapes</span> <span class="ow">in</span> <span class="n">level</span>  <span class="mi">3</span>   <span class="mi">32</span> <span class="n">x</span> <span class="mi">32</span>
</span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="n">num_cells</span> <span class="ow">in</span> <span class="n">level</span>  <span class="mi">3</span>   <span class="mi">1024</span>
</span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="n">Anchors</span> <span class="ow">in</span> <span class="n">Level</span> <span class="mi">3</span><span class="p">:</span> <span class="mi">3072</span>
</span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="n">backbone_shapes</span> <span class="ow">in</span> <span class="n">level</span>  <span class="mi">4</span>   <span class="mi">16</span> <span class="n">x</span> <span class="mi">16</span>
</span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="n">num_cells</span> <span class="ow">in</span> <span class="n">level</span>  <span class="mi">4</span>   <span class="mi">256</span>
</span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="n">Anchors</span> <span class="ow">in</span> <span class="n">Level</span> <span class="mi">4</span><span class="p">:</span> <span class="mi">768</span>
</span></span></code></pre></div><p>Trong kiến trức FPN, feature map tại một số layer đầu tiên là những feature map có độ phân giải lớn. Ví dụ, nếu bức ảnh đầu vào có kích thước là 1024x1024 pixel, và kích thước của mỗi anchor lớp đầu tiên là 32x32 pixel (giá trị đầu tiên của RPN_ANCHOR_SCALES (32, 64, 128, 256, 512)) và bước nhảy (STRIDE) của lớp đầu tiên là 4 (giá trị đầu tiên của BACKBONE_STRIDES ([4, 8, 16, 32, 64])). Từ những dữ kiện này, ta có thể suy ra được là sẽ sinh ra backbone cell có kích thước 256x256 pixel =&gt; 256x256 = 65536 anchor. Với mỗi backbone cell, chúng ta thực hiện phép scale với 3 tỷ lệ khác nhau là [0.5, 1, 2], vậy chúng ta có tổng cộng là 65536x3 = 196608 anchor (xấp xỉ 200k anchor). Để ý một điều là kích thước của một anchor là 32x32 pixel, và bước nhảy là 4, cho nên chúng ta sẽ bị chống lấn (overlap) 28 pixel của anchor 1 và anchor 2 ngay sau nó.</p>
<p>Một điều thú vị là, nếu ta tăng bước nhảy lên gấp 2 lần, ví dụ từ 4 pixel lấy một anchor lên 8 pixel lấy một anchor, thì số lượng anchor giảm đi đến 4 lần (196608 anchor ở level 0 so với 49152 anchor ở level 1).</p>
<p>Thử vẽ tất cả các anchor của tất cả các level ở điểm giữa một bức ảnh bức kỳ lên, mỗi một level sẽ dùng một màu khác nhau, chúng ta được một hình như bên dưới.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="c1"># Visualize anchors of one cell at the center of the feature map of a specific level</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">
</span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="c1"># Load and draw random image</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="n">image_id</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">image_ids</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="n">image</span><span class="p">,</span> <span class="n">image_meta</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">modellib</span><span class="o">.</span><span class="n">load_image_gt</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">image_id</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="n">levels</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">backbone_shapes</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">
</span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="n">kn_color</span> <span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span> <span class="p">[(</span><span class="mi">255</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),(</span><span class="mi">0</span><span class="p">,</span><span class="mi">255</span><span class="p">,</span><span class="mi">0</span><span class="p">),(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">255</span><span class="p">),(</span><span class="mi">128</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),(</span><span class="mi">0</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">0</span><span class="p">),(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">128</span><span class="p">)])</span><span class="o">/</span><span class="mf">255.</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl">
</span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="k">for</span> <span class="n">level</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">levels</span><span class="p">):</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl">    <span class="c1"># colors = visualize.random_colors(levels)</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl">    <span class="n">colors</span> <span class="o">=</span> <span class="n">kn_color</span>
</span></span><span class="line"><span class="ln">15</span><span class="cl">    <span class="c1"># Compute the index of the anchors at the center of the image</span>
</span></span><span class="line"><span class="ln">16</span><span class="cl">    <span class="n">level_start</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">anchors_per_level</span><span class="p">[:</span><span class="n">level</span><span class="p">])</span> <span class="c1"># sum of anchors of previous levels</span>
</span></span><span class="line"><span class="ln">17</span><span class="cl">    <span class="n">level_anchors</span> <span class="o">=</span> <span class="n">anchors</span><span class="p">[</span><span class="n">level_start</span><span class="p">:</span><span class="n">level_start</span><span class="o">+</span><span class="n">anchors_per_level</span><span class="p">[</span><span class="n">level</span><span class="p">]]</span>
</span></span><span class="line"><span class="ln">18</span><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Level </span><span class="si">{}</span><span class="s2">. Anchors: </span><span class="si">{:6}</span><span class="s2">  Feature map Shape: </span><span class="si">{}</span><span class="s2"> &#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">level</span><span class="p">,</span> <span class="n">level_anchors</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
</span></span><span class="line"><span class="ln">19</span><span class="cl">                                                                  <span class="n">backbone_shapes</span><span class="p">[</span><span class="n">level</span><span class="p">]))</span>
</span></span><span class="line"><span class="ln">20</span><span class="cl">    <span class="n">center_cell</span> <span class="o">=</span> <span class="n">backbone_shapes</span><span class="p">[</span><span class="n">level</span><span class="p">]</span> <span class="o">//</span> <span class="mi">2</span>
</span></span><span class="line"><span class="ln">21</span><span class="cl">    <span class="n">center_cell_index</span> <span class="o">=</span> <span class="p">(</span><span class="n">center_cell</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">backbone_shapes</span><span class="p">[</span><span class="n">level</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">center_cell</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span></span><span class="line"><span class="ln">22</span><span class="cl">    <span class="n">level_center</span> <span class="o">=</span> <span class="n">center_cell_index</span> <span class="o">*</span> <span class="n">anchors_per_cell</span>
</span></span><span class="line"><span class="ln">23</span><span class="cl">    <span class="n">center_anchor</span> <span class="o">=</span> <span class="n">anchors_per_cell</span> <span class="o">*</span> <span class="p">(</span>
</span></span><span class="line"><span class="ln">24</span><span class="cl">        <span class="p">(</span><span class="n">center_cell</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">backbone_shapes</span><span class="p">[</span><span class="n">level</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">config</span><span class="o">.</span><span class="n">RPN_ANCHOR_STRIDE</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> \
</span></span><span class="line"><span class="ln">25</span><span class="cl">        <span class="o">+</span> <span class="n">center_cell</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">config</span><span class="o">.</span><span class="n">RPN_ANCHOR_STRIDE</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">26</span><span class="cl">    <span class="n">level_center</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">center_anchor</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">27</span><span class="cl">
</span></span><span class="line"><span class="ln">28</span><span class="cl">    <span class="c1"># Draw anchors. Brightness show the order in the array, dark to bright.</span>
</span></span><span class="line"><span class="ln">29</span><span class="cl">    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">rect</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">level_anchors</span><span class="p">[</span><span class="n">level_center</span><span class="p">:</span><span class="n">level_center</span><span class="o">+</span><span class="n">anchors_per_cell</span><span class="p">]):</span>
</span></span><span class="line"><span class="ln">30</span><span class="cl">        <span class="n">y1</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">x2</span> <span class="o">=</span> <span class="n">rect</span>
</span></span><span class="line"><span class="ln">31</span><span class="cl">        <span class="n">p</span> <span class="o">=</span> <span class="n">patches</span><span class="o">.</span><span class="n">Rectangle</span><span class="p">((</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">),</span> <span class="n">x2</span><span class="o">-</span><span class="n">x1</span><span class="p">,</span> <span class="n">y2</span><span class="o">-</span><span class="n">y1</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">32</span><span class="cl">                              <span class="n">edgecolor</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">colors</span><span class="p">[</span><span class="n">level</span><span class="p">])</span> <span class="o">/</span> <span class="n">anchors_per_cell</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">33</span><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">34</span><span class="cl">        <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">35</span><span class="cl">
</span></span><span class="line"><span class="ln">36</span><span class="cl">
</span></span><span class="line"><span class="ln">37</span><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span></code></pre></div><p><img class="img-fluid" alt="Hình ảnh" src="/blog/2019-03-25-mask-rcnn-balloon/f-rcnn-image7.jpg" loading="lazy"  title="Hình ảnh"
  
   />

</p>
<p>Nhìn ảnh trên,các bạn phần nào đó mường tượng ra các anchor sẽ như thế nào rồi phải không.</p>
<h1 id="prediction">Prediction<a class="anchor ms-1" href="#prediction"><i class="fas fa-link"></i></a></h1>
<p>Để tiến hành detect vị trí quả bóng và mask của quả bóng, chúng ta download một ảnh small party nhỏ trên internet về và kiểm chứng.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="ln"> 1</span><span class="cl">
</span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="kn">import</span> <span class="nn">os</span>
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">
</span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">
</span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="kn">import</span> <span class="nn">cv2</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">
</span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="n">DEVICE</span> <span class="o">=</span> <span class="s2">&#34;/cpu:0&#34;</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="n">ROOT_DIR</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s2">&#34;../../&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="n">MODEL_DIR</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ROOT_DIR</span><span class="p">,</span> <span class="s2">&#34;logs&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="c1"># Create model in inference mode</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl">
</span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="k">class</span> <span class="nc">InferenceConfig</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="vm">__class__</span><span class="p">):</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl">    <span class="c1"># Run detection on one image at a time</span>
</span></span><span class="line"><span class="ln">15</span><span class="cl">    <span class="n">GPU_COUNT</span> <span class="o">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="ln">16</span><span class="cl">    <span class="n">IMAGES_PER_GPU</span> <span class="o">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="ln">17</span><span class="cl">
</span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="n">config</span> <span class="o">=</span> <span class="n">InferenceConfig</span><span class="p">()</span>
</span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="n">config</span><span class="o">.</span><span class="n">display</span><span class="p">()</span>
</span></span><span class="line"><span class="ln">20</span><span class="cl">
</span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="n">DEVICE</span><span class="p">):</span>
</span></span><span class="line"><span class="ln">22</span><span class="cl">    <span class="n">model</span> <span class="o">=</span> <span class="n">modellib</span><span class="o">.</span><span class="n">MaskRCNN</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s2">&#34;inference&#34;</span><span class="p">,</span> <span class="n">model_dir</span><span class="o">=</span><span class="n">MODEL_DIR</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">23</span><span class="cl">                              <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">24</span><span class="cl">
</span></span><span class="line"><span class="ln">25</span><span class="cl">
</span></span><span class="line"><span class="ln">26</span><span class="cl"><span class="n">weights_path</span> <span class="o">=</span> <span class="s2">&#34;mask_rcnn_balloon.h5&#34;</span>
</span></span><span class="line"><span class="ln">27</span><span class="cl">
</span></span><span class="line"><span class="ln">28</span><span class="cl"><span class="c1"># Load weights</span>
</span></span><span class="line"><span class="ln">29</span><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Loading weights &#34;</span><span class="p">,</span> <span class="n">weights_path</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">30</span><span class="cl"><span class="c1"># model.load_weights(weights_path, by_name=True)</span>
</span></span><span class="line"><span class="ln">31</span><span class="cl">
</span></span><span class="line"><span class="ln">32</span><span class="cl"><span class="n">imgpath</span> <span class="o">=</span> <span class="s2">&#34;datasets</span><span class="se">\\</span><span class="s2">balloon</span><span class="se">\\</span><span class="s2">test</span><span class="se">\\</span><span class="s2">t1.png&#34;</span>
</span></span><span class="line"><span class="ln">33</span><span class="cl"><span class="c1"># imgpath = &#34;datasets/balloon/val/14898532020_ba6199dd22_k.jpg&#34;</span>
</span></span><span class="line"><span class="ln">34</span><span class="cl">
</span></span><span class="line"><span class="ln">35</span><span class="cl"><span class="n">image</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">imgpath</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">36</span><span class="cl">
</span></span><span class="line"><span class="ln">37</span><span class="cl"><span class="n">image</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">image</span><span class="p">,</span><span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2RGB</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">38</span><span class="cl">
</span></span><span class="line"><span class="ln">39</span><span class="cl">
</span></span><span class="line"><span class="ln">40</span><span class="cl">
</span></span><span class="line"><span class="ln">41</span><span class="cl"><span class="n">ds_name</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;BG&#39;</span><span class="p">,</span> <span class="s1">&#39;balloon&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">42</span><span class="cl">
</span></span><span class="line"><span class="ln">43</span><span class="cl">
</span></span><span class="line"><span class="ln">44</span><span class="cl"><span class="n">results</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">detect</span><span class="p">([</span><span class="n">image</span><span class="p">],</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">45</span><span class="cl">
</span></span><span class="line"><span class="ln">46</span><span class="cl"><span class="k">def</span> <span class="nf">get_ax</span><span class="p">(</span><span class="n">rows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">cols</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">16</span><span class="p">):</span>
</span></span><span class="line"><span class="ln">47</span><span class="cl">    <span class="s2">&#34;&#34;&#34;Return a Matplotlib Axes array to be used in
</span></span></span><span class="line"><span class="ln">48</span><span class="cl"><span class="s2">    all visualizations in the notebook. Provide a
</span></span></span><span class="line"><span class="ln">49</span><span class="cl"><span class="s2">    central point to control graph sizes.
</span></span></span><span class="line"><span class="ln">50</span><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="ln">51</span><span class="cl"><span class="s2">    Adjust the size attribute to control how big to render images
</span></span></span><span class="line"><span class="ln">52</span><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="ln">53</span><span class="cl">    <span class="n">_</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">size</span><span class="o">*</span><span class="n">cols</span><span class="p">,</span> <span class="n">size</span><span class="o">*</span><span class="n">rows</span><span class="p">))</span>
</span></span><span class="line"><span class="ln">54</span><span class="cl">    <span class="k">return</span> <span class="n">ax</span>
</span></span><span class="line"><span class="ln">55</span><span class="cl"><span class="c1"># Display results</span>
</span></span><span class="line"><span class="ln">56</span><span class="cl"><span class="n">ax</span> <span class="o">=</span> <span class="n">get_ax</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">57</span><span class="cl"><span class="n">r</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">58</span><span class="cl"><span class="n">visualize</span><span class="o">.</span><span class="n">display_instances</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;rois&#39;</span><span class="p">],</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;masks&#39;</span><span class="p">],</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;class_ids&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="ln">59</span><span class="cl">                            <span class="n">dataset</span><span class="o">.</span><span class="n">class_names</span><span class="p">,</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;scores&#39;</span><span class="p">],</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">60</span><span class="cl">                            <span class="n">title</span><span class="o">=</span><span class="s2">&#34;Predictions&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">61</span><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span></code></pre></div><p><img class="img-fluid" alt="Hình ảnh" src="/blog/2019-03-25-mask-rcnn-balloon/f-rcnn-image8.jpg" loading="lazy"  title="Hình ảnh"
  
   />

</p>
<p>Kết quả nhận dạng khá chính xác phải không các bạn.</p>
<p>Cảm ơn các bạn đã theo dõi. Hẹn gặp bạn ở các bài viết tiếp theo.</p>
</div></div>
  <div class="card-footer"><div class="post-navs d-flex justify-content-evenly"><div class="post-nav post-prev">
    <i class="fas fa-fw fa-chevron-left"></i>
    <a href="/blog/2019-03-16-vietnamese-accent/">Thêm Dấu Tiếng Việt Cho Câu Không Dấu
</a>
  </div><div class="post-nav post-next">
    <a href="/blog/2019-04-02-deep-learning-view/">Trí Tuệ Nhân Tạo, Máy Học, Dữ Liệu Lớn
</a>
    <i class="fas fa-fw fa-chevron-right"></i>
  </div></div></div>
</article><div class="card component row post-comments" id="post-comments">
  <div class="card-header">
    <h2 class="card-title">Comments</h2>
  </div>
  <div class="card-body"><script src="https://utteranc.es/client.js"
  repo="AlexBlack2202/utterances"
  issue-term="pathname"
  label="comment"
  theme="github-dark"
  crossorigin="anonymous"
  async>
</script></div>
</div></div>
</div><aside class="col-lg-3 col-md-4 sidebar d-flex">
  <div class="container d-flex flex-column">
    
    <div class="post-toc row mb-4 card component" id="postTOC">
  <div class="card-header">
    <h2 class="card-title">Contents</h2>
  </div>
  <div class="card-body">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#bắt-đầu">Bắt đầu</a></li>
    <li><a href="#visualize-dữ-liệu">Visualize dữ liệu</a></li>
    <li><a href="#bounding-boxes">Bounding Boxes</a></li>
    <li><a href="#resize-images">Resize Images</a></li>
    <li><a href="#mini-masks">Mini Masks</a></li>
    <li><a href="#anchors">Anchors</a></li>
    <li><a href="#prediction">Prediction</a></li>
  </ul>
</nav>
  </div>
</div><section class="recent-posts row card component">
  <div class="card-header">
    <h2 class="card-title">Recent Posts</h2>
  </div>
  <div class="card-body">
    <ul class="post-list"><li>
        <a href="/blog/2025-04-26-how-brands-grow/">Khám Phá Bí Mật Đằng Sau Sự Thành Công Của Các Thương Hiệu
</a>
      </li><li>
        <a href="/blog/2025-04-11-hash-equilibrium/">Tuyết Giác Trúc Lâm - Truyện AI
</a>
      </li><li>
        <a href="/blog/2025-04-20-ai-viet-truyen-tuyet-giac-truc-lam/">Cân Bằng Nash - Nash Equilibrium
</a>
      </li><li>
        <a href="/blog/2025-04-10-prisoner-dilemma/">Prisoner’s Dilemma - Song Đề Tù Nhân
</a>
      </li><li>
        <a href="/blog/2025-04-07-generative-ai-expertise-teamwork/">Song Kiếm Hợp Bích Giữa Generative Ai Và Chuyên Viên. Nấc Thang Lên Thiên Đường
</a>
      </li></ul>
  </div>
</section><section class="series-taxonomies row card component">
      <div class="card-header">
        <h2 class="card-title">
          <a href="/series">series</a>
        </h2>
      </div>
      <div class="card-body">
        <div class="py-2"><a href="/series/kh%C3%B3a-h%E1%BB%8Dc-python-c%C4%83n-b%E1%BA%A3n/" class="badge rounded post-taxonomy" title="Khóa Học Python Căn Bản">
            Khóa Học Python Căn Bản<span class="badge badge-sm text-white bg-accent ms-1">5</span></a><a href="/series/kh%C3%B3a-h%E1%BB%8Dc-c&#43;&#43;-c%C4%83n-b%E1%BA%A3n/" class="badge rounded post-taxonomy" title="Khóa Học C&#43;&#43; Căn Bản">
            Khóa Học C&#43;&#43; Căn Bản<span class="badge badge-sm text-white bg-accent ms-1">3</span></a><a href="/series/machine-learning-dataset/" class="badge rounded post-taxonomy" title="Machine Learning Dataset">
            Machine Learning Dataset<span class="badge badge-sm text-white bg-accent ms-1">2</span></a><a href="/series/ch%E1%BB%A9ng-kho%C3%A1n-c%C4%83n-b%E1%BA%A3n/" class="badge rounded post-taxonomy" title="Chứng Khoán Căn Bản">
            Chứng Khoán Căn Bản<span class="badge badge-sm text-white bg-accent ms-1">1</span></a></div>
      </div>
    </section><section class="tools-taxonomies row card component">
      <div class="card-header">
        <h2 class="card-title">
          <a href="/tools">tools</a>
        </h2>
      </div>
      <div class="card-body">
        <div class="py-2"><a href="/tools/tool-random/" class="badge rounded post-taxonomy" title="Tool Random">
            Tool Random<span class="badge badge-sm text-white bg-accent ms-1">2</span></a></div>
      </div>
    </section><section class="categories-taxonomies row card component">
      <div class="card-header">
        <h2 class="card-title">
          <a href="/categories">categories</a>
        </h2>
      </div>
      <div class="card-body">
        <div class="py-2"><a href="/categories/python/" class="badge rounded post-taxonomy" title="Python">
            Python<span class="badge badge-sm text-white bg-accent ms-1">5</span></a><a href="/categories/c&#43;&#43;/" class="badge rounded post-taxonomy" title="C&#43;&#43;">
            C&#43;&#43;<span class="badge badge-sm text-white bg-accent ms-1">3</span></a><a href="/categories/dataset/" class="badge rounded post-taxonomy" title="Dataset">
            Dataset<span class="badge badge-sm text-white bg-accent ms-1">2</span></a></div>
      </div>
    </section><section class="tags-taxonomies row card component">
      <div class="card-header">
        <h2 class="card-title">
          <a href="/tags">tags</a>
        </h2>
      </div>
      <div class="card-body">
        <div class="py-2"><a href="/tags/machine-learning/" class="badge rounded post-taxonomy" title="Machine Learning">
            Machine Learning<span class="badge badge-sm text-white bg-accent ms-1">45</span></a><a href="/tags/deep-learning/" class="badge rounded post-taxonomy" title="Deep Learning">
            Deep Learning<span class="badge badge-sm text-white bg-accent ms-1">21</span></a><a href="/tags/deeplearning/" class="badge rounded post-taxonomy" title="DeepLearning">
            DeepLearning<span class="badge badge-sm text-white bg-accent ms-1">21</span></a><a href="/tags/python/" class="badge rounded post-taxonomy" title="Python">
            Python<span class="badge badge-sm text-white bg-accent ms-1">11</span></a><a href="/tags/opencv/" class="badge rounded post-taxonomy" title="Opencv">
            Opencv<span class="badge badge-sm text-white bg-accent ms-1">5</span></a><a href="/tags/c&#43;&#43;/" class="badge rounded post-taxonomy" title="C&#43;&#43;">
            C&#43;&#43;<span class="badge badge-sm text-white bg-accent ms-1">4</span></a><a href="/tags/game-theory/" class="badge rounded post-taxonomy" title="Game Theory">
            Game Theory<span class="badge badge-sm text-white bg-accent ms-1">4</span></a><a href="/tags/normalization/" class="badge rounded post-taxonomy" title="Normalization">
            Normalization<span class="badge badge-sm text-white bg-accent ms-1">4</span></a><a href="/tags/object-detector/" class="badge rounded post-taxonomy" title="Object Detector">
            Object Detector<span class="badge badge-sm text-white bg-accent ms-1">4</span></a><a href="/tags/recommendation/" class="badge rounded post-taxonomy" title="Recommendation">
            Recommendation<span class="badge badge-sm text-white bg-accent ms-1">4</span></a></div>
      </div>
    </section>
    
  </div>
</aside>
</div>
    </main><footer class="footer mt-auto py-3 text-center container"><ul class="nav justify-content-between footer-memu mb-3"><li class="nav-item"><ul class="nav flex-column align-items-start">
      <li class="nav-item">
        <a class="nav-link fw-bold" target="_blank" rel="noopener noreferrer">Support
</a>
      </li><li class="nav-item">
            <a class="nav-link" href="https://www.facebook.com/groups/1354425091720104" target="_blank" rel="noopener noreferrer"><i class="fab fa-fw fa-github"></i>Repository
</a>
        </li><li class="nav-item">
            <a class="nav-link" href="https://www.facebook.com/groups/1354425091720104" target="_blank" rel="noopener noreferrer"><i class="fas fa-fw fa-comments"></i>Discussions
</a>
        </li><li class="nav-item">
            <a class="nav-link" href="/contact/"><i class="fas fa-fw fa-info-circle"></i>Contact Us
</a>
        </li><li class="nav-item">
            <a class="nav-link" href="/faq/"><i class="fas fa-fw fa-question-circle"></i>FAQs
</a>
        </li></ul></li><li class="nav-item"><ul class="nav flex-column align-items-start">
      <li class="nav-item">
        <a class="nav-link fw-bold" target="_blank" rel="noopener noreferrer">Docs
</a>
      </li><li class="nav-item">
            <a class="nav-link" href="/team_of_services" target="_blank" rel="noopener noreferrer"><i class="fas fa-fw fa-users"></i>Điều khoản sử dụng
</a>
        </li><li class="nav-item">
            <a class="nav-link" href="/privacy" target="_blank" rel="noopener noreferrer"><i class="fas fa-fw fa-lock"></i>Chính sách bảo mật
</a>
        </li></ul></li><li class="nav-item"><ul class="nav flex-column align-items-start">
      <li class="nav-item">
        <a class="nav-link fw-bold" target="_blank" rel="noopener noreferrer">Features
</a>
      </li><li class="nav-item">
            <a class="nav-link" href="https://www.phamduytung.com/utils/gen_paswords/" target="_blank" rel="noopener noreferrer"><i class="fas fa-fw fa-paw"></i>Tạo password ngẫu nhiên
</a>
        </li></ul></li><li class="nav-item"><ul class="nav flex-column align-items-start">
      <li class="nav-item">
        <a class="nav-link fw-bold" target="_blank" rel="noopener noreferrer">Liên kết khác
</a>
      </li><li class="nav-item">
            <a class="nav-link" href="https://www.facebook.com/groups/1354425091720104" target="_blank" rel="noopener noreferrer">Netlify
</a>
        </li><li class="nav-item">
            <a class="nav-link" href="https://www.facebook.com/groups/1354425091720104" target="_blank" rel="noopener noreferrer">facebook
</a>
        </li></ul></li></ul>
<div class="copyright mb-2">
  Copyright © 2016-2025 Phạm Duy Tùng. All Rights Reserved.
</div>
<div class="powered-by mb-2">
  Website chia sẻ kiến thức của Phạm Duy Tùng và Đặng Thị Hằng. Vui lòng liên hệ email alexblack2202@gmail.com nếu bạn có thông tin cần trao đổi.
</div></footer>
<script src="/js/main.ed2053ad82a243b263761567b5c1aaf974487aa84adacb89ae3ddf803ecc248a.js" integrity="sha256-7SBTrYKiQ7JjdhVntcGq&#43;XRIeqhK2suJrj3fgD7MJIo=" crossorigin="anonymous" defer></script><script src="/js/icons.min.8ff200851002b8138e6b35314683092e02edc155465d9dbfb7d115460f8f1fbe.js" integrity="sha256-j/IAhRACuBOOazUxRoMJLgLtwVVGXZ2/t9EVRg&#43;PH74=" crossorigin="anonymous" defer></script>
<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('\/service-worker.js').then(function(reg) {
      console.log('Successfully registered service worker', reg);
    }).catch(function(err) {
      console.warn('Error whilst registering service worker', err);
    });
  });
}
</script><script src="/js/viewer.min.ec58d2aa1a8916addf393be975fdf0070e8c872b0caef1673cb9f7eea067ce57.js" integrity="sha256-7FjSqhqJFq3fOTvpdf3wBw6MhysMrvFnPLn37qBnzlc=" crossorigin="anonymous" defer></script><script defer src="/js/katex.min.d5052035160facae59b60000106771baf2eb7671123813d21f1097a5a9218b6e.js" integrity="sha256-1QUgNRYPrK5ZtgAAEGdxuvLrdnESOBPSHxCXpakhi24=" crossorigin="anonymous"></script>

<script  data-ad-client="ca-pub-4644989745435991"  async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4644989745435991"
     crossorigin="anonymous"></script><script data-cfasync="false" type="text/javascript" data-adel="atag" src="//acscdn.com/script/atg.js" czid="eul3gyjdmm"></script>
  </body>
</html>
